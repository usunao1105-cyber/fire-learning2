<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FireLog - 消防車両管理システム</title>
    
    <!-- Tailwind CSS (スタイリング用) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UI構築用) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (JSX変換用) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- アイコンスタイル等の調整 -->
    <style>
        body { font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        .animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- アイコンコンポーネント (Lucide IconsのSVG定義) ---
        const IconWrapper = ({ children, color = "currentColor", size = 24, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        const Truck = (props) => <IconWrapper {...props}><path d="M10 17h4V5H2v12h3" /><path d="M20 17h2v-3.34a4 4 0 0 0-1.17-2.83L19 9h-5" /><path d="M14 17h1" /><circle cx="7.5" cy="17.5" r="2.5" /><circle cx="17.5" cy="17.5" r="2.5" /></IconWrapper>;
        const Wrench = (props) => <IconWrapper {...props}><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" /></IconWrapper>;
        const Calendar = (props) => <IconWrapper {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></IconWrapper>;
        const Users = (props) => <IconWrapper {...props}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M23 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></IconWrapper>;
        const AlertTriangle = (props) => <IconWrapper {...props}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></IconWrapper>;
        const CheckCircle = (props) => <IconWrapper {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></IconWrapper>;
        const FileText = (props) => <IconWrapper {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><polyline points="10 9 9 9 8 9" /></IconWrapper>;
        const Save = (props) => <IconWrapper {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></IconWrapper>;
        const Clock = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></IconWrapper>;
        const ChevronRight = (props) => <IconWrapper {...props}><polyline points="9 18 15 12 9 6" /></IconWrapper>;
        const ArrowLeft = (props) => <IconWrapper {...props}><line x1="19" y1="12" x2="5" y2="12" /><polyline points="12 19 5 12 12 5" /></IconWrapper>;
        const Search = (props) => <IconWrapper {...props}><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /></IconWrapper>;
        const PlusCircle = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="16" /><line x1="8" y1="12" x2="16" y2="12" /></IconWrapper>;
        const ShieldAlert = (props) => <IconWrapper {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></IconWrapper>;
        const History = (props) => <IconWrapper {...props}><path d="M3 3v5h5" /><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8" /><path d="M12 7v5l4 2" /></IconWrapper>;
        const Trash2 = (props) => <IconWrapper {...props}><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></IconWrapper>;
        const X = (props) => <IconWrapper {...props}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></IconWrapper>;
        const Info = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10" /><line x1="12" y1="16" x2="12" y2="12" /><line x1="12" y1="8" x2="12.01" y2="8" /></IconWrapper>;
        const Edit3 = (props) => <IconWrapper {...props}><path d="M12 20h9" /><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" /></IconWrapper>;
        const RefreshCw = (props) => <IconWrapper {...props}><polyline points="23 4 23 10 17 10" /><polyline points="1 20 1 14 7 14" /><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" /></IconWrapper>;
        const Download = (props) => <IconWrapper {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></IconWrapper>;

        // --- モックデータ (初期データ) ---
        const INITIAL_VEHICLES = [
            {
                id: 'v001',
                name: 'ポンプ車 第1小隊',
                plate: '三河800 あ 11-99',
                type: '消防ポンプ自動車 (CD-I型)',
                deploymentDate: '2020-04-01',
                status: 'operational', // operational, maintenance, caution
                mileage: 12500,
                nextInspection: '2026-04-01',
                staff: {
                    primary: '司令 鈴木 一郎',
                    secondary: '士長 佐藤 健'
                },
                damages: [
                    { id: 1, x: 20, y: 30, description: 'バンパー左下 擦り傷 (3cm)', date: '2023-11-10', reporter: '佐藤' }
                ],
                logs: [
                    { id: 101, date: '2025-12-01', type: '法定点検', title: '6ヶ月点検', details: 'オイル交換、タイヤ空気圧調整。異常なし。', reporter: '鈴木' },
                    { id: 102, date: '2026-01-05', type: '修理', title: '無線機不調', details: '接触不良のためコネクタ交換実施。', reporter: '佐藤' }
                ]
            },
            {
                id: 'v002',
                name: '高規格救急車 第1',
                plate: '三河800 い 88-88',
                type: '高規格救急自動車',
                deploymentDate: '2022-10-01',
                status: 'operational',
                mileage: 45000,
                nextInspection: '2026-10-01',
                staff: {
                    primary: '司令補 田中 未来',
                    secondary: '副士長 山田 太郎'
                },
                damages: [],
                logs: []
            },
            {
                id: 'v003',
                name: 'はしご車 (30m)',
                plate: '三河800 は 30-30',
                type: '30m級はしご付消防自動車',
                deploymentDate: '2015-06-01',
                status: 'maintenance',
                mileage: 8000,
                nextInspection: '2026-06-01',
                staff: {
                    primary: '司令 高橋 誠',
                    secondary: '士長 伊藤 勇気'
                },
                damages: [
                    { id: 2, x: 80, y: 50, description: 'アウトリガーカバー 塗装剥げ', date: '2024-02-15', reporter: '高橋' }
                ],
                logs: [
                    { id: 201, date: '2026-01-08', type: '故障', title: '油圧系統アラート', details: 'はしご伸梯時に異音確認のためドック入り中。', reporter: '伊藤' }
                ]
            }
        ];

        // --- コンポーネント ---

        // トースト通知
        const Toast = ({ message, type, onClose }) => {
            if (!message) return null;
            const bgColor = type === 'error' ? 'bg-red-600' : 'bg-green-600';
            return (
                <div className={`fixed bottom-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 z-50 animate-fade-in-up`}>
                    {type === 'error' ? <AlertTriangle size={20} /> : <CheckCircle size={20} />}
                    <span className="font-bold">{message}</span>
                    <button onClick={onClose} className="ml-4 hover:bg-white/20 p-1 rounded"><X size={16} /></button>
                </div>
            );
        };

        // 1. 車両外観図（簡易SVG）と傷記録
        const VehicleBodyMap = ({ damages, onAddDamage, readOnly = false }) => {
            const [clickPos, setClickPos] = useState(null);
            const [newDamageText, setNewDamageText] = useState('');
            const [newDamageReporter, setNewDamageReporter] = useState('');

            const handleMapClick = (e) => {
                if (readOnly) return;
                const rect = e.target.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                setClickPos({ x, y });
            };

            const handleSaveDamage = () => {
                if (!newDamageText || !newDamageReporter) {
                    alert("損傷内容と発見者・記録者を入力してください");
                    return;
                }
                
                if (clickPos) {
                    onAddDamage({
                        x: clickPos.x,
                        y: clickPos.y,
                        description: newDamageText,
                        reporter: newDamageReporter,
                        date: new Date().toISOString().split('T')[0]
                    });
                    setClickPos(null);
                    setNewDamageText('');
                    setNewDamageReporter('');
                }
            };

            return (
                <div className="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                    <h3 className="text-lg font-bold text-gray-800 mb-2 flex items-center">
                        <Search className="w-5 h-5 mr-2" /> 外観チェック・傷確認
                    </h3>
                    <p className="text-sm text-gray-500 mb-4">
                        車両の図をクリックして、新たな傷や損傷を記録してください。
                        <br />※ 小さな傷も見逃さずに記録を残すことで、車両の状態を保全します。
                    </p>

                    <div className="relative w-full h-64 bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg overflow-hidden cursor-crosshair" onClick={handleMapClick}>
                        {/* 簡易的な車両の図 (Top View) */}
                        <svg className="w-full h-full text-gray-300" viewBox="0 0 400 200" preserveAspectRatio="none">
                            <path d="M50,40 Q50,20 80,20 L320,20 Q350,20 350,40 L350,160 Q350,180 320,180 L80,180 Q50,180 50,160 Z" fill="none" stroke="currentColor" strokeWidth="2" />
                            <rect x="80" y="30" width="80" height="140" fill="none" stroke="currentColor" strokeWidth="2" />
                            <rect x="70" y="10" width="40" height="15" fill="currentColor" />
                            <rect x="70" y="175" width="40" height="15" fill="currentColor" />
                            <rect x="290" y="10" width="40" height="15" fill="currentColor" />
                            <rect x="290" y="175" width="40" height="15" fill="currentColor" />
                            <line x1="110" y1="30" x2="110" y2="170" stroke="currentColor" strokeWidth="1" />
                            <text x="370" y="100" fill="#9ca3af" fontSize="12" textAnchor="middle">後方</text>
                            <text x="30" y="100" fill="#9ca3af" fontSize="12" textAnchor="middle">前方</text>
                        </svg>

                        {/* 既存の傷マーカー */}
                        {damages.map((d) => (
                            <div
                                key={d.id}
                                className="absolute w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs font-bold shadow-lg transform -translate-x-1/2 -translate-y-1/2 group cursor-pointer"
                                style={{ left: `${d.x}%`, top: `${d.y}%` }}
                            >
                                !
                                {/* Tooltip */}
                                <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-48 bg-gray-900 text-white text-xs rounded p-2 hidden group-hover:block z-10">
                                    <p className="font-bold">{d.description}</p>
                                    <p className="text-gray-300">{d.date} 記録</p>
                                    <p className="text-gray-400">担当: {d.reporter}</p>
                                </div>
                            </div>
                        ))}

                        {/* 新規登録用マーカー */}
                        {clickPos && (
                            <div
                                className="absolute w-6 h-6 bg-blue-500 border-2 border-white rounded-full animate-pulse transform -translate-x-1/2 -translate-y-1/2"
                                style={{ left: `${clickPos.x}%`, top: `${clickPos.y}%` }}
                            />
                        )}
                    </div>

                    {clickPos && !readOnly && (
                        <div className="mt-4 p-4 bg-blue-50 border border-blue-200 rounded animate-fade-in shadow-inner">
                            <h4 className="font-bold text-blue-800 mb-2">新規損傷の記録</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-2">
                                <div>
                                    <label className="text-xs font-bold text-gray-500 block mb-1">損傷内容</label>
                                    <input
                                        type="text"
                                        className="w-full p-2 border border-gray-300 rounded"
                                        placeholder="例: バンパーに3cmの擦り傷"
                                        value={newDamageText}
                                        onChange={(e) => setNewDamageText(e.target.value)}
                                    />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500 block mb-1">発見者/記録者</label>
                                    <input
                                        type="text"
                                        className="w-full p-2 border border-gray-300 rounded"
                                        placeholder="氏名を入力"
                                        value={newDamageReporter}
                                        onChange={(e) => setNewDamageReporter(e.target.value)}
                                    />
                                </div>
                            </div>
                            <div className="flex justify-end gap-2 mt-2">
                                <button
                                    onClick={() => setClickPos(null)}
                                    className="px-3 py-1 text-gray-600 hover:bg-gray-200 rounded"
                                >
                                    キャンセル
                                </button>
                                <button
                                    onClick={handleSaveDamage}
                                    className="px-4 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold"
                                >
                                    記録する
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 2. メインアプリ
        function App() {
            const [view, setView] = useState('dashboard');
            const [vehicles, setVehicles] = useState(INITIAL_VEHICLES);
            const [selectedVehicleId, setSelectedVehicleId] = useState(null);
            const [activeTab, setActiveTab] = useState('history');

            // UI状態管理
            const [showAddModal, setShowAddModal] = useState(false);
            const [showDeleteModal, setShowDeleteModal] = useState(false);
            const [notification, setNotification] = useState(null);
            const [showMileageModal, setShowMileageModal] = useState(false);
            const [tempMileage, setTempMileage] = useState('');
            const [showStatusModal, setShowStatusModal] = useState(false);

            // 新規登録フォーム用
            const [newVehicleForm, setNewVehicleForm] = useState({
                name: '',
                plate: '',
                type: '',
                nextInspection: ''
            });

            // ログ入力用ステート
            const [showLogModal, setShowLogModal] = useState(false);
            const [newLogTitle, setNewLogTitle] = useState('');
            const [newLogDate, setNewLogDate] = useState('');
            const [newLogReporter, setNewLogReporter] = useState('');

            // 日常点検用ステート
            const [inspectionReporter, setInspectionReporter] = useState('');

            const selectedVehicle = vehicles.find(v => v.id === selectedVehicleId);

            const showToast = (message, type = 'success') => {
                setNotification({ message, type });
                setTimeout(() => setNotification(null), 3000);
            };

            // CSVエクスポート
            const handleExportCSV = () => {
                if (!selectedVehicle) return;
                const logsHeader = ['日付', '種別', '件名', '内容', '記録者'];
                const logsRows = selectedVehicle.logs.map(log => [
                    log.date,
                    log.type,
                    log.title,
                    log.details,
                    log.reporter
                ]);
                const csvContent = [
                    logsHeader.join(','),
                    ...logsRows.map(row => row.map(cell => `"${(cell || '').replace(/"/g, '""')}"`).join(','))
                ].join('\n');
                const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
                const blob = new Blob([bom, csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${selectedVehicle.name}_車歴簿_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                showToast('車歴簿をCSV出力しました');
            };

            const StatusBadge = ({ status }) => {
                const config = {
                    operational: { color: 'bg-green-100 text-green-800', text: '出向可', icon: CheckCircle },
                    maintenance: { color: 'bg-red-100 text-red-800', text: '整備中/故障', icon: Wrench },
                    caution: { color: 'bg-yellow-100 text-yellow-800', text: '点検推奨', icon: AlertTriangle },
                };
                const { color, text, icon: Icon } = config[status] || config.operational;
                return (
                    <span className={`flex items-center gap-1 px-3 py-1 rounded-full text-sm font-bold ${color}`}>
                        <Icon size={16} /> {text}
                    </span>
                );
            };

            // 処理関数群
            const handleUpdateMileage = () => {
                const mileage = parseInt(tempMileage.replace(/,/g, ''), 10);
                if (isNaN(mileage)) { showToast("有効な数値を入力してください", "error"); return; }
                setVehicles(prev => prev.map(v => v.id === selectedVehicleId ? { ...v, mileage: mileage } : v));
                setShowMileageModal(false);
                showToast("走行距離を更新しました");
            };

            const handleUpdateStatus = (newStatus) => {
                setVehicles(prev => prev.map(v => v.id === selectedVehicleId ? { ...v, status: newStatus } : v));
                setShowStatusModal(false);
                showToast("車両ステータスを更新しました");
            };

            const handleAddLog = (vehicleId) => {
                if (!newLogTitle || !newLogDate || !newLogReporter) { showToast("日付、件名、記録者は必須です", "error"); return; }
                const newLog = { id: Date.now(), date: newLogDate, type: 'その他', title: newLogTitle, details: '手動入力', reporter: newLogReporter };
                setVehicles(prev => prev.map(v => {
                    if (v.id === vehicleId) {
                        const updatedLogs = [newLog, ...v.logs].sort((a, b) => new Date(b.date) - new Date(a.date));
                        return { ...v, logs: updatedLogs };
                    }
                    return v;
                }));
                setShowLogModal(false);
                setNewLogTitle(''); setNewLogDate(''); setNewLogReporter('');
                showToast('記録を追加しました');
            };

            const handleAddDamage = (damageData) => {
                const newDamage = { id: Date.now(), ...damageData };
                setVehicles(prev => prev.map(v => v.id === selectedVehicleId ? { ...v, damages: [...v.damages, newDamage] } : v));
                showToast('損傷情報を記録しました');
            };

            const handleUpdateStaff = (field, name) => {
                setVehicles(prev => prev.map(v => v.id === selectedVehicleId ? { ...v, staff: { ...v.staff, [field]: name } } : v));
            };

            const handleCreateVehicle = () => {
                if (!newVehicleForm.name || !newVehicleForm.plate) { showToast("車両名とナンバープレートは必須です", "error"); return; }
                const newVehicle = {
                    id: `v-${Date.now()}`,
                    name: newVehicleForm.name,
                    plate: newVehicleForm.plate,
                    type: newVehicleForm.type || '種別未設定',
                    deploymentDate: new Date().toISOString().split('T')[0],
                    status: 'operational',
                    mileage: 0,
                    nextInspection: newVehicleForm.nextInspection || '未設定',
                    staff: { primary: '未設定', secondary: '未設定' },
                    damages: [],
                    logs: []
                };
                setVehicles([...vehicles, newVehicle]);
                setShowAddModal(false);
                setNewVehicleForm({ name: '', plate: '', type: '', nextInspection: '' });
                setSelectedVehicleId(newVehicle.id);
                setView('detail');
                showToast('新しい車両を登録しました');
            };

            const executeDeleteVehicle = () => {
                setVehicles(vehicles.filter(v => v.id !== selectedVehicleId));
                setSelectedVehicleId(null);
                setShowDeleteModal(false);
                setView('dashboard');
                showToast('車両を削除しました', 'success');
            };

            // --- 描画ロジック ---
            if (view === 'dashboard') {
                return (
                    <div className="min-h-screen bg-gray-100 font-sans text-gray-800 relative">
                        <Toast message={notification?.message} type={notification?.type} onClose={() => setNotification(null)} />
                        
                        <header className="bg-red-700 text-white p-4 shadow-md sticky top-0 z-10">
                            <div className="max-w-6xl mx-auto flex justify-between items-center">
                                <h1 className="text-2xl font-bold flex items-center gap-2">
                                    <ShieldAlert className="w-8 h-8" />
                                    FireLog 車両管理システム
                                </h1>
                            </div>
                        </header>

                        <main className="max-w-6xl mx-auto p-4">
                            <div className="flex flex-col md:flex-row justify-between items-end mb-6 gap-4">
                                <div>
                                    <h2 className="text-xl font-bold text-gray-700">配備車両一覧 ({vehicles.length}台)</h2>
                                    <p className="text-gray-500">点検および管理を行う車両を選択してください。</p>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="hidden md:flex gap-2 text-xs text-gray-500">
                                        <div className="flex items-center gap-1"><div className="w-2 h-2 bg-green-500 rounded-full"></div>出向可</div>
                                        <div className="flex items-center gap-1"><div className="w-2 h-2 bg-red-500 rounded-full"></div>整備中</div>
                                    </div>
                                    <button onClick={() => setShowAddModal(true)} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow flex items-center gap-2 font-bold transition-colors">
                                        <PlusCircle className="w-5 h-5" /> 新規車両登録
                                    </button>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {vehicles.map(vehicle => (
                                    <div key={vehicle.id} className="bg-white rounded-lg shadow-md hover:shadow-xl transition-all cursor-pointer overflow-hidden border-t-4 border-gray-200 hover:border-red-500 relative group"
                                        onClick={() => { setSelectedVehicleId(vehicle.id); setView('detail'); }}>
                                        <div className="p-5">
                                            <div className="flex justify-between items-start mb-3">
                                                <StatusBadge status={vehicle.status} />
                                                <span className="text-xs text-gray-400 font-mono">ID: {vehicle.id}</span>
                                            </div>
                                            <h3 className="text-xl font-bold mb-1 truncate">{vehicle.name}</h3>
                                            <p className="text-lg text-gray-600 font-mono bg-gray-50 inline-block px-2 py-0.5 rounded mb-4">{vehicle.plate}</p>
                                            <div className="space-y-2 text-sm text-gray-600">
                                                <div className="flex items-center gap-2"><Calendar className="w-4 h-4 text-gray-400" /><span>車検: {vehicle.nextInspection}</span></div>
                                                <div className="flex items-center gap-2"><Users className="w-4 h-4 text-gray-400" /><span className="truncate">担: {vehicle.staff.primary}</span></div>
                                            </div>
                                        </div>
                                        <div className="bg-gray-50 px-5 py-3 border-t flex justify-between items-center text-sm font-medium text-blue-600">
                                            <span>車歴簿・点検を開く</span><ChevronRight className="w-4 h-4" />
                                        </div>
                                    </div>
                                ))}
                                {vehicles.length === 0 && (
                                    <div className="col-span-full py-12 text-center text-gray-400 border-2 border-dashed rounded-lg">
                                        <p>登録されている車両はありません。</p><p>「新規車両登録」ボタンから車両を追加してください。</p>
                                    </div>
                                )}
                            </div>
                        </main>

                        {showAddModal && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden animate-fade-in">
                                    <div className="bg-red-700 text-white p-4 flex justify-between items-center">
                                        <h3 className="font-bold flex items-center gap-2"><Truck className="w-5 h-5"/> 新規車両の登録</h3>
                                        <button onClick={() => setShowAddModal(false)} className="hover:bg-red-600 p-1 rounded"><X className="w-5 h-5"/></button>
                                    </div>
                                    <div className="p-6 space-y-4">
                                        <div><label className="block text-sm font-bold text-gray-700 mb-1">車両名称 <span className="text-red-500">*</span></label>
                                            <input type="text" className="w-full border p-2 rounded focus:ring-2 focus:ring-red-500 outline-none" placeholder="例: 救助工作車 第2" value={newVehicleForm.name} onChange={(e) => setNewVehicleForm({...newVehicleForm, name: e.target.value})} /></div>
                                        <div><label className="block text-sm font-bold text-gray-700 mb-1">ナンバープレート <span className="text-red-500">*</span></label>
                                            <input type="text" className="w-full border p-2 rounded focus:ring-2 focus:ring-red-500 outline-none" placeholder="例: 三河800 さ 99-99" value={newVehicleForm.plate} onChange={(e) => setNewVehicleForm({...newVehicleForm, plate: e.target.value})} /></div>
                                        <div><label className="block text-sm font-bold text-gray-700 mb-1">車両種別</label>
                                            <input type="text" className="w-full border p-2 rounded focus:ring-2 focus:ring-red-500 outline-none" placeholder="例: 救助工作車 III型" value={newVehicleForm.type} onChange={(e) => setNewVehicleForm({...newVehicleForm, type: e.target.value})} /></div>
                                        <div><label className="block text-sm font-bold text-gray-700 mb-1">次回車検・点検期限</label>
                                            <input type="date" className="w-full border p-2 rounded focus:ring-2 focus:ring-red-500 outline-none" value={newVehicleForm.nextInspection} onChange={(e) => setNewVehicleForm({...newVehicleForm, nextInspection: e.target.value})} /></div>
                                    </div>
                                    <div className="bg-gray-50 p-4 flex justify-end gap-3 border-t">
                                        <button onClick={() => setShowAddModal(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded font-medium">キャンセル</button>
                                        <button onClick={handleCreateVehicle} className="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-bold shadow">登録する</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            // --- 詳細画面 ---
            return (
                <div className="min-h-screen bg-gray-100 font-sans text-gray-800 relative">
                    <Toast message={notification?.message} type={notification?.type} onClose={() => setNotification(null)} />
                    
                    <header className="bg-white border-b shadow-sm sticky top-0 z-20">
                        <div className="max-w-6xl mx-auto px-4 py-3">
                            <div className="flex justify-between items-center mb-2">
                                <button onClick={() => { setView('dashboard'); setActiveTab('history'); }} className="flex items-center text-gray-500 hover:text-red-600 transition-colors">
                                    <ArrowLeft className="w-4 h-4 mr-1" /> 車両一覧に戻る
                                </button>
                                <div className="flex gap-2">
                                    <button onClick={handleExportCSV} className="text-xs text-blue-600 hover:text-blue-800 hover:bg-blue-50 px-2 py-1 rounded flex items-center gap-1 transition-colors border border-transparent hover:border-blue-200" title="車歴簿をCSV出力">
                                        <Download className="w-3 h-3" /> CSV出力
                                    </button>
                                    <button onClick={() => setShowDeleteModal(true)} className="text-xs text-red-500 hover:text-red-700 hover:bg-red-50 px-2 py-1 rounded flex items-center gap-1 transition-colors">
                                        <Trash2 className="w-3 h-3" /> 車両削除
                                    </button>
                                </div>
                            </div>
                            <div className="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
                                <div>
                                    <div className="flex items-center gap-3">
                                        <h1 className="text-2xl font-bold text-gray-800">{selectedVehicle.name}</h1>
                                        <button onClick={() => setShowStatusModal(true)} className="hover:opacity-80 transition-opacity cursor-pointer flex items-center gap-1 hover:bg-gray-100 rounded px-1 -ml-1" title="ステータスを変更">
                                            <StatusBadge status={selectedVehicle.status} /><Edit3 className="w-4 h-4 text-gray-400" />
                                        </button>
                                    </div>
                                    <p className="text-gray-500 font-mono mt-1">{selectedVehicle.plate} | {selectedVehicle.type}</p>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="text-right hidden md:block">
                                        <p className="text-xs text-gray-400">現在走行距離</p>
                                        <button onClick={() => { setTempMileage(selectedVehicle.mileage.toString()); setShowMileageModal(true); }} className="flex items-center gap-2 hover:bg-gray-50 px-2 py-1 rounded group cursor-pointer border border-transparent hover:border-gray-200 transition-all">
                                            <p className="font-mono font-bold text-lg">{selectedVehicle.mileage.toLocaleString()} km</p><Edit3 className="w-4 h-4 text-gray-300 group-hover:text-blue-500" />
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="max-w-6xl mx-auto px-4 mt-2 overflow-x-auto">
                            <nav className="flex space-x-6">
                                {[ { id: 'history', label: '車歴簿 (履歴)', icon: History }, { id: 'inspection', label: '日常点検', icon: CheckCircle }, { id: 'damages', label: '外観・傷確認', icon: Search }, { id: 'staff', label: '担当者管理', icon: Users } ].map(tab => (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`pb-3 flex items-center gap-2 whitespace-nowrap border-b-2 transition-colors ${ activeTab === tab.id ? 'border-red-600 text-red-600 font-bold' : 'border-transparent text-gray-500 hover:text-gray-700' }`}>
                                        <tab.icon className="w-4 h-4" />{tab.label}
                                    </button>
                                ))}
                            </nav>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto p-4 py-6">
                        {activeTab === 'history' && (
                            <div className="space-y-6">
                                <div className="bg-white rounded-lg shadow-sm p-6">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-xl font-bold flex items-center gap-2"><FileText className="w-5 h-5" /> メンテナンス・故障履歴</h2>
                                        <button onClick={() => { setNewLogTitle(''); setNewLogDate(new Date().toISOString().split('T')[0]); setNewLogReporter(''); setShowLogModal(true); }} className="bg-blue-600 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-blue-700">
                                            <PlusCircle className="w-4 h-4" /> 新規記録
                                        </button>
                                    </div>
                                    {selectedVehicle.logs.length === 0 ? (
                                        <div className="text-center py-10 text-gray-400">記録がありません</div>
                                    ) : (
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-left border-collapse">
                                                <thead>
                                                    <tr className="bg-gray-50 text-gray-600 text-sm border-b">
                                                        <th className="p-3 w-32">日付</th><th className="p-3 w-24">種別</th><th className="p-3">件名・内容</th><th className="p-3 w-32">記録者</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {selectedVehicle.logs.map(log => (
                                                        <tr key={log.id} className="border-b hover:bg-gray-50">
                                                            <td className="p-3 font-mono text-gray-600 whitespace-nowrap">{log.date}</td>
                                                            <td className="p-3"><span className={`text-xs px-2 py-1 rounded-full whitespace-nowrap ${ log.type === '故障' ? 'bg-red-100 text-red-800' : log.type === '法定点検' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800' }`}>{log.type}</span></td>
                                                            <td className="p-3"><div className="font-bold">{log.title}</div><div className="text-sm text-gray-500">{log.details}</div></td>
                                                            <td className="p-3 text-sm text-gray-600">{log.reporter}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'inspection' && (
                            <div className="max-w-2xl mx-auto">
                                <div className="bg-white rounded-lg shadow-sm p-6 border-t-4 border-green-500">
                                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2"><CheckCircle className="w-6 h-6 text-green-600" /> 始業点検 / 日常点検</h2>
                                    <p className="text-sm text-gray-500 mb-6">出向前の確認事項です。異常がある場合は直ちに報告してください。</p>
                                    <div className="space-y-4">
                                        {['エンジンオイル・冷却水量', 'タイヤ空気圧・損傷', 'バッテリー・灯火類', 'サイレン・赤色灯・無線機', '積載資機材の員数確認'].map((item, idx) => (
                                            <div key={idx} className="flex items-center justify-between p-3 border rounded hover:bg-gray-50">
                                                <span className="font-medium">{item}</span>
                                                <div className="flex gap-2"><button className="px-4 py-2 border rounded hover:bg-red-50 text-red-600 text-sm">異常</button><button className="px-4 py-2 bg-green-50 border border-green-200 text-green-700 rounded font-bold shadow-sm hover:bg-green-100">良</button></div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="mt-6 pt-4 border-t">
                                        <label className="block text-sm font-bold mb-2">特記事項・申し送り</label>
                                        <textarea className="w-full border rounded p-2 h-24" placeholder="気になる点があれば記入してください..."></textarea>
                                    </div>
                                    <div className="mt-4">
                                        <label className="block text-sm font-bold mb-2">点検者 <span className="text-red-500">*</span></label>
                                        <input type="text" className="w-full border p-2 rounded focus:ring-2 focus:ring-green-500 outline-none" placeholder="氏名を入力" value={inspectionReporter} onChange={(e) => setInspectionReporter(e.target.value)} />
                                    </div>
                                    <button className="w-full mt-6 bg-green-600 text-white font-bold py-3 rounded-lg shadow hover:bg-green-700 flex justify-center items-center gap-2"
                                        onClick={() => {
                                            if (!inspectionReporter) { showToast("点検者を入力してください", "error"); return; }
                                            setVehicles(prev => prev.map(v => v.id === selectedVehicleId ? { ...v, logs: [{ id: Date.now(), date: new Date().toISOString().split('T')[0], type: '日常点検', title: '始業点検実施', details: '全項目異常なし。', reporter: inspectionReporter }, ...v.logs] } : v));
                                            setInspectionReporter(''); showToast("点検記録を保存しました");
                                        }}>
                                        <Save className="w-5 h-5" /> 点検完了・記録保存
                                    </button>
                                </div>
                            </div>
                        )}

                        {activeTab === 'damages' && (
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div className="lg:col-span-2"><VehicleBodyMap damages={selectedVehicle.damages} onAddDamage={handleAddDamage} /></div>
                                <div className="space-y-4">
                                    <div className="bg-white p-4 rounded-lg shadow-sm">
                                        <h3 className="font-bold border-b pb-2 mb-2">損傷リスト</h3>
                                        {selectedVehicle.damages.length === 0 && <p className="text-gray-400 text-sm">記録された損傷はありません。</p>}
                                        <ul className="space-y-3">
                                            {selectedVehicle.damages.map(d => (
                                                <li key={d.id} className="text-sm bg-red-50 p-3 rounded border border-red-100">
                                                    <div className="font-bold text-red-800">{d.description}</div>
                                                    <div className="flex justify-between text-gray-500 mt-1 text-xs"><span>{d.date}</span><span>{d.reporter}</span></div>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'staff' && (
                            <div className="max-w-2xl mx-auto space-y-6">
                                <div className="bg-yellow-50 border border-yellow-200 p-4 rounded-lg flex gap-3">
                                    <AlertTriangle className="w-6 h-6 text-yellow-600 flex-shrink-0" />
                                    <div className="text-sm text-yellow-800">
                                        <p className="font-bold mb-1">担当者変更のルール</p>
                                        <p>車両の維持管理責任を明確にするため、必ず正・副の2名体制を維持してください。</p>
                                    </div>
                                </div>
                                <div className="bg-white p-6 rounded-lg shadow-sm">
                                    <h3 className="text-lg font-bold mb-6 flex items-center gap-2"><Users className="w-5 h-5" /> 現在の車両担当者</h3>
                                    <div className="grid gap-6">
                                        <div className="p-4 border rounded-lg relative">
                                            <div className="absolute top-0 left-0 bg-blue-600 text-white text-xs px-2 py-1 rounded-br">正担当</div>
                                            <div className="mt-4"><label className="block text-sm text-gray-500 mb-1">階級・氏名</label><input type="text" value={selectedVehicle.staff.primary} onChange={(e) => handleUpdateStaff('primary', e.target.value)} className="w-full text-lg font-bold border-b-2 border-gray-200 focus:border-blue-500 outline-none py-1" /></div>
                                        </div>
                                        <div className="p-4 border rounded-lg relative bg-gray-50">
                                            <div className="absolute top-0 left-0 bg-gray-500 text-white text-xs px-2 py-1 rounded-br">副担当</div>
                                            <div className="mt-4"><label className="block text-sm text-gray-500 mb-1">階級・氏名</label><input type="text" value={selectedVehicle.staff.secondary} onChange={(e) => handleUpdateStaff('secondary', e.target.value)} className="w-full text-lg font-bold bg-transparent border-b-2 border-gray-200 focus:border-blue-500 outline-none py-1" /></div>
                                        </div>
                                    </div>
                                    <div className="mt-6 flex justify-end"><button onClick={() => showToast('担当者情報を更新しました')} className="bg-gray-800 text-white px-6 py-2 rounded hover:bg-gray-700">担当者情報を更新</button></div>
                                </div>
                            </div>
                        )}
                    </main>

                    {showDeleteModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-lg shadow-xl w-full max-w-sm overflow-hidden animate-fade-in p-6">
                                <div className="flex items-center gap-3 text-red-600 mb-4"><AlertTriangle className="w-8 h-8" /><h3 className="text-lg font-bold">車両を削除しますか？</h3></div>
                                <p className="text-gray-600 mb-6"><strong>{selectedVehicle.name}</strong> を登録解除します。<br/>この操作を行うと、過去の点検履歴や傷の記録もすべて削除されます。</p>
                                <div className="flex justify-end gap-3"><button onClick={() => setShowDeleteModal(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">キャンセル</button><button onClick={executeDeleteVehicle} className="px-4 py-2 bg-red-600 text-white rounded font-bold hover:bg-red-700 shadow">削除を実行</button></div>
                            </div>
                        </div>
                    )}

                    {showMileageModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
                                <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><Truck className="w-5 h-5"/> 走行距離の更新</h3>
                                <div className="flex items-center gap-2 mb-6"><input type="number" className="w-full border p-2 text-lg font-mono font-bold text-right rounded focus:ring-2 focus:ring-blue-500 outline-none" value={tempMileage} onChange={(e) => setTempMileage(e.target.value)} autoFocus /><span className="font-bold text-gray-600">km</span></div>
                                <div className="flex justify-end gap-3"><button onClick={() => setShowMileageModal(false)} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">キャンセル</button><button onClick={handleUpdateMileage} className="px-4 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">更新</button></div>
                            </div>
                        </div>
                    )}

                    {showStatusModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
                                <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><RefreshCw className="w-5 h-5"/> ステータスの変更</h3>
                                <div className="space-y-3">
                                    <button onClick={() => handleUpdateStatus('operational')} className={`w-full p-4 rounded-lg border-2 text-left transition-all ${selectedVehicle.status === 'operational' ? 'border-green-500 bg-green-50 ring-1 ring-green-500' : 'border-gray-200 hover:border-green-300'}`}><div className="flex items-center gap-2 font-bold text-green-800"><CheckCircle className="w-5 h-5" /> 出向可</div><div className="text-xs text-green-600 mt-1 pl-7">通常運用・出場可能な状態です。</div></button>
                                    <button onClick={() => handleUpdateStatus('maintenance')} className={`w-full p-4 rounded-lg border-2 text-left transition-all ${selectedVehicle.status === 'maintenance' ? 'border-red-500 bg-red-50 ring-1 ring-red-500' : 'border-gray-200 hover:border-red-300'}`}><div className="flex items-center gap-2 font-bold text-red-800"><Wrench className="w-5 h-5" /> 整備中/故障</div><div className="text-xs text-red-600 mt-1 pl-7">ドック入り、または重大な故障により運用不可です。</div></button>
                                    <button onClick={() => handleUpdateStatus('caution')} className={`w-full p-4 rounded-lg border-2 text-left transition-all ${selectedVehicle.status === 'caution' ? 'border-yellow-500 bg-yellow-50 ring-1 ring-yellow-500' : 'border-gray-200 hover:border-yellow-300'}`}><div className="flex items-center gap-2 font-bold text-yellow-800"><AlertTriangle className="w-5 h-5" /> 点検推奨</div><div className="text-xs text-yellow-600 mt-1 pl-7">運用可能ですが、不具合等により注意が必要です。</div></button>
                                </div>
                                <div className="flex justify-end mt-6"><button onClick={() => setShowStatusModal(false)} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">キャンセル</button></div>
                            </div>
                        </div>
                    )}

                    {showLogModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                                <h3 className="text-lg font-bold mb-4">新規ログの記録</h3>
                                <div className="mb-4"><label className="block text-sm font-bold text-gray-700 mb-1">日付 <span className="text-red-500">*</span></label><input type="date" className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" value={newLogDate} onChange={(e) => setNewLogDate(e.target.value)} /></div>
                                <div className="mb-4"><label className="block text-sm font-bold text-gray-700 mb-1">件名 <span className="text-red-500">*</span></label><input type="text" className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="例: オイル交換" value={newLogTitle} onChange={(e) => setNewLogTitle(e.target.value)} /></div>
                                <div className="mb-4"><label className="block text-sm font-bold text-gray-700 mb-1">記録者 <span className="text-red-500">*</span></label><input type="text" className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="氏名を入力" value={newLogReporter} onChange={(e) => setNewLogReporter(e.target.value)} /></div>
                                <div className="flex justify-end gap-3"><button onClick={() => setShowLogModal(false)} className="px-4 py-2 text-gray-500">キャンセル</button><button onClick={() => handleAddLog(selectedVehicle.id)} className="px-4 py-2 bg-blue-600 text-white rounded font-bold">保存</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
