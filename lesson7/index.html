<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FIRE MEMO - FireRescueLog</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* 基本設定 */
        body {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Noto Sans JP', sans-serif;
        }
        .cloak { display: none; }

        /* --- マニュアル用アニメーション定義 (消防用シナリオ) --- */
        @keyframes tap { 0% { opacity: 0; transform: scale(1.5); } 50% { opacity: 0.5; transform: scale(1); } 100% { opacity: 0; transform: scale(1.5); } }
        .tap-effect { animation: tap 0.5s ease-out forwards; transform-origin: center; }
        
        /* 指の動き: Start -> 接触 -> CPR -> 救急隊接触 -> End -> Copy */
        @keyframes fingerMoveFire {
            0% { transform: translate(295px, 120px); opacity: 0; } /* Start */
            5% { transform: translate(295px, 120px); opacity: 1; }
            10% { transform: translate(295px, 120px) scale(0.9); }
            15% { transform: translate(295px, 120px); opacity: 0; }

            20% { transform: translate(185px, 447px); opacity: 0; } /* 接触 (Row1, Center) */
            25% { transform: translate(185px, 447px); opacity: 1; }
            30% { transform: translate(185px, 447px) scale(0.9); }
            35% { transform: translate(185px, 447px); opacity: 0; }

            40% { transform: translate(185px, 502px); opacity: 0; } /* CPR (Row2, Center) */
            45% { transform: translate(185px, 502px); opacity: 1; }
            50% { transform: translate(185px, 502px) scale(0.9); }
            55% { transform: translate(185px, 502px); opacity: 0; }

            60% { transform: translate(305px, 447px); opacity: 0; } /* 救急隊接触 (Row1, Right) */
            65% { transform: translate(305px, 447px); opacity: 1; }
            70% { transform: translate(305px, 447px) scale(0.9); }
            75% { transform: translate(305px, 447px); opacity: 0; }

            80% { transform: translate(295px, 205px); opacity: 0; } /* End Activity */
            85% { transform: translate(295px, 205px); opacity: 1; }
            90% { transform: translate(295px, 205px) scale(0.9); }
            95% { transform: translate(295px, 205px); opacity: 0; }
            
            100% { opacity: 0; }
        }
        #finger { animation: fingerMoveFire 14s infinite; }

        /* ログ出現アニメーション */
        @keyframes showLog1 { 0%, 10% { opacity: 0; transform: translateY(10px); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes showLog2 { 0%, 30% { opacity: 0; transform: translateY(10px); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes showLog3 { 0%, 50% { opacity: 0; transform: translateY(10px); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes showLog4 { 0%, 70% { opacity: 0; transform: translateY(10px); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes showModal { 0%, 90% { opacity: 0; } 95%, 100% { opacity: 1; } }
        @keyframes timerBarAnim { 0% { width: 0; } 100% { width: 120px; } }
        
        #log-start { animation: showLog1 14s infinite; }
        #log-contact { animation: showLog2 14s infinite; }
        #log-cpr { animation: showLog3 14s infinite; }
        #log-ems { animation: showLog4 14s infinite; }
        #export-modal { animation: showModal 14s infinite; }
        .timer-bar-anim { animation: timerBarAnim 12s infinite linear; }

        /* --- 印刷設定 (A4用紙向け) --- */
        @page { size: A4; margin: 10mm; }
        @media print {
            body { background-color: white; }
            .no-print { display: none !important; } /* アプリ画面やナビゲーションを隠す */
            .manual-print-area { display: block !important; } /* マニュアル部分を強制表示 */
            
            /* 印刷用レイアウトのリセット */
            .print-page {
                width: 100%; height: 100%; box-shadow: none; border: none; margin: 0; padding: 0; page-break-after: always;
            }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- Icons ---
        const Icon = ({ size = 24, className = "", children }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );
        const Activity = (props) => <Icon {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12" /></Icon>;
        const Clock = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></Icon>;
        const Send = (props) => <Icon {...props}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></Icon>;
        const FileText = (props) => <Icon {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></Icon>;
        const Trash2 = (props) => <Icon {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></Icon>;
        const Copy = (props) => <Icon {...props}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></Icon>;
        const Save = (props) => <Icon {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>;
        const RotateCcw = (props) => <Icon {...props}><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></Icon>;
        const ChevronDown = (props) => <Icon {...props}><polyline points="6 9 12 15 18 9"/></Icon>;
        const ChevronUp = (props) => <Icon {...props}><polyline points="18 15 12 9 6 15"/></Icon>;
        const AlertTriangle = (props) => <Icon {...props}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></Icon>;
        const StopCircle = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><rect x="9" y="9" width="6" height="6"/></Icon>;
        const Play = (props) => <Icon {...props}><polygon points="5 3 19 12 5 21 5 3"/></Icon>;
        const Hash = (props) => <Icon {...props}><line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="15" x2="20" y2="15"/><line x1="10" y1="3" x2="8" y2="21"/><line x1="16" y1="3" x2="14" y2="21"/></Icon>;
        const Flag = (props) => <Icon {...props}><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></Icon>;
        const HelpCircle = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></Icon>;
        const X = (props) => <Icon {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></Icon>;
        const Flame = (props) => <Icon {...props}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></Icon>;

        // --- Helper Functions ---
        const formatTime = (date) => {
            return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        };

        const formatElapsed = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        };

        // --- Constants (Updated for Fire Rescue) ---
        const QUICK_ACTIONS = [
            { label: '現着', type: 'milestone' },
            { label: '接触', type: 'milestone' },
            { label: '救急隊接触', type: 'milestone' },
            { label: 'ドクターカー接触', type: 'milestone' },
            { label: '心電図', type: 'treatment' },
            { label: '酸素投与', type: 'treatment' },
            { label: 'CPR開始', type: 'treatment' },
            { label: '除細動', type: 'treatment' },
            { label: 'バイタル測定', type: 'vitals' },
            { label: 'ROSC', type: 'vitals' },
            { label: 'かかりつけ', type: 'vitals' },
            { label: 'SAMPLE', type: 'vitals' },
        ];

        // --- Manual Component (Merged & Updated for Fire Rescue) ---
        const Manual = ({ onClose }) => {
            return (
                <div className="fixed inset-0 bg-gray-100 z-50 overflow-y-auto">
                    {/* Header / Close Button (Hidden on Print) */}
                    <div className="no-print fixed top-0 left-0 right-0 bg-red-800 text-white p-4 shadow-md z-50 flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <HelpCircle size={24} className="text-yellow-400" />
                            <h2 className="font-bold text-lg">取扱説明書 (消防隊用)</h2>
                        </div>
                        <button onClick={onClose} className="bg-red-700 hover:bg-red-600 px-4 py-2 rounded-full text-sm font-bold flex items-center gap-2 border border-white/20">
                            <X size={16} /> 閉じる
                        </button>
                    </div>

                    {/* Animation Section (Hidden on Print) */}
                    <div className="no-print mt-20 mb-8 px-4 max-w-lg mx-auto">
                        <div className="bg-white rounded-3xl overflow-hidden shadow-xl border-4 border-gray-700 relative aspect-[375/667]">
                            {/* Updated SVG without 'xmlns' and with CSS animation class for timer */}
                            <svg viewBox="0 0 375 667" className="w-full h-full">
                                <rect width="100%" height="100%" fill="#f3f4f6"/>
                                <rect width="100%" height="180" fill="#991b1b"/>
                                <text x="20" y="40" fill="white" fontWeight="bold" fontSize="20">FIRE MEMO</text>
                                <text x="20" y="100" fill="#fca5a5" fontSize="12">ELAPSED TIME</text>
                                <text x="20" y="150" fill="white" fontFamily="monospace" fontWeight="bold" fontSize="40">00:00</text>
                                {/* Timer animation replaced with CSS class */}
                                <rect x="20" y="160" width="10" height="2" fill="white" className="timer-bar-anim" />
                                
                                {/* Header Buttons */}
                                <g transform="translate(240, 100)"><rect width="110" height="40" rx="8" fill="#16a34a"/><text x="55" y="25" textAnchor="middle" fill="white" fontSize="14" fontWeight="bold">計測開始</text></g>
                                <g transform="translate(240, 150)"><rect width="110" height="30" rx="6" fill="#16a34a"/><text x="55" y="20" textAnchor="middle" fill="white" fontSize="12">ピリオド 1</text></g>
                                <g transform="translate(240, 190)"><rect width="110" height="30" rx="6" fill="#dc2626"/><text x="55" y="20" textAnchor="middle" fill="white" fontSize="12">活動終了</text></g>
                                
                                {/* Incident Input */}
                                <rect x="20" y="60" width="200" height="30" rx="4" fill="#7f1d1d"/>
                                <text x="30" y="80" fill="#fecaca" fontSize="12">事案番号...</text>
                                
                                {/* Log Area - Animated */}
                                <g transform="translate(10, 200)">
                                    <g id="log-start" className="log-item"><rect x="10" y="10" width="335" height="40" rx="4" fill="#eff6ff"/><rect x="10" y="10" width="4" height="40" fill="#3b82f6"/><text x="25" y="35" fontSize="14" fill="#1e3a8a">活動開始</text></g>
                                    <g id="log-contact" className="log-item" transform="translate(0, 50)"><rect x="10" y="10" width="335" height="40" rx="4" fill="#eff6ff"/><rect x="10" y="10" width="4" height="40" fill="#3b82f6"/><text x="25" y="35" fontSize="14" fill="#1e3a8a">接触</text><text x="280" y="35" fontSize="10" fill="#64748b" fontFamily="monospace">+01:20</text></g>
                                    <g id="log-cpr" className="log-item" transform="translate(0, 100)"><rect x="10" y="10" width="335" height="40" rx="4" fill="#fef2f2"/><rect x="10" y="10" width="4" height="40" fill="#ef4444"/><text x="25" y="35" fontSize="14" fill="#7f1d1d">【処置】CPR開始</text><text x="280" y="35" fontSize="10" fill="#64748b" fontFamily="monospace">+02:15</text></g>
                                    <g id="log-ems" className="log-item" transform="translate(0, 150)"><rect x="10" y="10" width="335" height="40" rx="4" fill="#eff6ff"/><rect x="10" y="10" width="4" height="40" fill="#3b82f6"/><text x="25" y="35" fontSize="14" fill="#1e3a8a">救急隊接触</text><text x="280" y="35" fontSize="10" fill="#64748b" fontFamily="monospace">+08:30</text></g>
                                </g>
                                
                                {/* Input Area */}
                                <g transform="translate(0, 580)"><rect width="100%" height="90" fill="white" stroke="#e5e7eb"/><rect x="20" y="15" width="280" height="40" rx="20" fill="#f3f4f6"/><text x="40" y="40" fill="#9ca3af">メモを入力...</text><circle cx="340" cy="35" r="20" fill="#2563eb"/><path d="M335 35 L340 30 L345 35" stroke="white" strokeWidth="2" fill="none"/></g>
                                
                                {/* Quick Actions Panel (Simulated for Animation) */}
                                <g transform="translate(0, 430)"><rect width="100%" height="150" fill="#f9fafb" stroke="#e5e7eb"/>
                                    {/* Row 1 */}
                                    <rect x="10" y="10" width="110" height="35" rx="4" fill="#dbeafe" stroke="#bfdbfe"/><text x="65" y="32" textAnchor="middle" fontSize="12" fill="#1e40af">現着</text>
                                    <rect x="130" y="10" width="110" height="35" rx="4" fill="#dbeafe" stroke="#bfdbfe"/><text x="185" y="32" textAnchor="middle" fontSize="12" fill="#1e40af">接触</text>
                                    <rect x="250" y="10" width="110" height="35" rx="4" fill="#dbeafe" stroke="#bfdbfe"/><text x="305" y="32" textAnchor="middle" fontSize="12" fill="#1e40af">救急隊接触</text>
                                    
                                    {/* Row 2 */}
                                    <rect x="10" y="55" width="110" height="35" rx="4" fill="#fee2e2" stroke="#fecaca"/><text x="65" y="77" textAnchor="middle" fontSize="12" fill="#991b1b">心電図</text>
                                    <rect x="130" y="55" width="110" height="35" rx="4" fill="#fee2e2" stroke="#fecaca"/><text x="185" y="77" textAnchor="middle" fontSize="12" fill="#991b1b">CPR開始</text>
                                    <rect x="250" y="55" width="110" height="35" rx="4" fill="#dcfce7" stroke="#bbf7d0"/><text x="305" y="77" textAnchor="middle" fontSize="12" fill="#166534">ROSC</text>
                                </g>
                                
                                {/* Export Modal Overlay */}
                                <g id="export-modal"><rect width="100%" height="100%" fill="rgba(0,0,0,0.5)"/><g transform="translate(40, 180)"><rect width="295" height="300" rx="8" fill="white"/><rect width="295" height="50" rx="8" fill="#f8fafc"/><text x="20" y="32" fontWeight="bold" fill="#334155">活動記録出力</text><rect x="20" y="70" width="255" height="150" fill="#f1f5f9" stroke="#cbd5e1"/><rect x="30" y="85" width="200" height="6" fill="#94a3b8" rx="2"/><rect x="30" y="100" width="180" height="6" fill="#cbd5e1" rx="2"/><rect x="30" y="115" width="220" height="6" fill="#cbd5e1" rx="2"/><rect x="30" y="130" width="150" height="6" fill="#cbd5e1" rx="2"/><rect x="20" y="240" width="120" height="40" rx="4" fill="#2563eb"/><text x="80" y="265" textAnchor="middle" fill="white" fontSize="14">コピー</text><rect x="155" y="240" width="120" height="40" rx="4" fill="#e2e8f0"/><text x="215" y="265" textAnchor="middle" fill="#475569" fontSize="14">閉じる</text></g></g>
                                
                                {/* Moving Finger */}
                                <circle id="finger" cx="0" cy="0" r="15" fill="rgba(255, 165, 0, 0.7)" stroke="white" strokeWidth="2" pointerEvents="none"/>
                            </svg>
                        </div>
                        <p className="text-center text-gray-500 mt-4 text-sm">画面の指示に従って操作してください。<br/>印刷する場合は <span className="font-bold">Ctrl + P</span> (Macは Cmd + P) を押してください。</p>
                    </div>

                    {/* Printable Section (Hidden on Screen via styles if needed, but we rely on media query) */}
                    <div className="manual-print-area max-w-[210mm] mx-auto bg-white p-[15mm] shadow-lg print-page mb-20">
                        <div className="border-b-4 border-red-800 pb-2 mb-6 flex justify-between items-end">
                            <div>
                                <p className="text-sm text-gray-500 mb-1">消防隊活動支援アプリ</p>
                                <h1 className="text-3xl font-bold text-red-900">FIRE MEMO クイックガイド</h1>
                            </div>
                            <div className="text-right">
                                <p className="text-sm">Ver 1.1 (FireRescue)</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-8 h-full">
                            <div>
                                <div className="border-2 border-gray-200 rounded-lg p-4 mb-4 relative">
                                    <div className="absolute -top-4 left-3 bg-red-800 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">1</div>
                                    <h3 className="font-bold text-lg mb-2 border-b pb-1">活動の開始</h3>
                                    <p className="text-sm mb-2">指令時または現着時に、画面右上の<span class="bg-green-600 text-white px-2 py-0.5 rounded text-xs mx-1">計測開始</span>ボタンをタップします。</p>
                                    <ul className="list-disc list-inside text-sm text-gray-600 pl-2">
                                        <li>タイマーが00:00からスタートします。</li>
                                        <li>自動的に「活動開始」のログが記録されます。</li>
                                    </ul>
                                </div>

                                <div className="border-2 border-gray-200 rounded-lg p-4 mb-4 relative">
                                    <div className="absolute -top-4 left-3 bg-red-800 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">2</div>
                                    <h3 className="font-bold text-lg mb-2 border-b pb-1">活動記録（PA連携）</h3>
                                    <p className="text-sm mb-3">画面下部のボタンパネルから、実施した応急処置や引き継ぎ状況をタップします。</p>
                                    <div className="grid grid-cols-2 gap-2 text-xs mb-3">
                                        <div className="bg-red-100 border border-red-300 p-2 rounded text-center"><span className="text-red-600 font-bold">赤色ボタン</span><br/>心電図・酸素・CPRなど<br/>「応急処置」</div>
                                        <div className="bg-blue-100 border border-blue-300 p-2 rounded text-center"><span className="text-blue-800 font-bold">青色ボタン</span><br/>現着・救急隊接触など<br/>「マイルストーン」</div>
                                        <div className="bg-green-100 border border-green-300 p-2 rounded text-center"><span className="text-green-600 font-bold">緑色ボタン</span><br/>ROSC・かかりつけ・SAMPLEなど<br/>「状態・情報」</div>
                                    </div>
                                    <p className="text-sm font-bold text-blue-800">重要：救急隊やドクターカーへの引き継ぎ時は「救急隊接触」「ドクターカー接触」ボタンを使用します。</p>
                                </div>
                            </div>

                            <div>
                                <div className="border-2 border-gray-200 rounded-lg p-4 mb-4 relative">
                                    <div className="absolute -top-4 left-3 bg-red-800 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">3</div>
                                    <h3 className="font-bold text-lg mb-2 border-b pb-1">ピリオド管理</h3>
                                    <p className="text-sm">CPR中など、時間の区切りをつけたい場合は<span class="bg-green-600 text-white px-2 py-0.5 rounded text-xs mx-1">ピリオド</span>ボタンを押します。</p>
                                </div>

                                <div className="border-2 border-gray-200 rounded-lg p-4 mb-4 relative">
                                    <div className="absolute -top-4 left-3 bg-red-800 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">4</div>
                                    <h3 className="font-bold text-lg mb-2 border-b pb-1">活動終了と書き出し</h3>
                                    <p className="text-sm mb-2">活動終了後、<span class="bg-red-600 text-white px-2 py-0.5 rounded text-xs mx-1">活動終了</span>ボタンを押してデータをコピーします。</p>
                                    <p class="text-xs text-gray-500 mt-2">報告書作成や救急隊への申し送りに活用してください。</p>
                                </div>

                                <div className="border-2 border-yellow-200 bg-yellow-50 rounded-lg p-4 relative">
                                    <h3 className="font-bold text-sm text-yellow-800 mb-1">⚠️ リセット</h3>
                                    <p className="text-xs text-gray-700">書き出し終了後は、必ず<span class="bg-gray-600 text-white px-1 py-0.5 rounded text-xs mx-1">リセット</span>して次の出動に備えてください。</p>
                                </div>
                            </div>
                        </div>
                        <div className="mt-8 pt-4 border-t text-center text-xs text-gray-400">FireRescueLog Application System</div>
                    </div>
                </div>
            );
        };

        // --- App Component ---
        function App() {
            // --- State ---
            const [logs, setLogs] = useState([]);
            const [inputText, setInputText] = useState('');
            const [startTime, setStartTime] = useState(null);
            const [endTime, setEndTime] = useState(null);
            const [elapsed, setElapsed] = useState(0);
            const [showExport, setShowExport] = useState(false);
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const [quickActionsOpen, setQuickActionsOpen] = useState(true);
            const [incidentNumber, setIncidentNumber] = useState('');
            const [periodCount, setPeriodCount] = useState(1);
            
            // New State for Manual
            const [showManual, setShowManual] = useState(false);
            
            // Refs
            const logsEndRef = useRef(null);

            // --- Timer Logic ---
            useEffect(() => {
                let interval;
                if (startTime && !endTime) {
                interval = setInterval(() => {
                    const now = new Date();
                    const diff = Math.floor((now.getTime() - startTime.getTime()) / 1000);
                    setElapsed(diff);
                }, 1000);
                }
                return () => clearInterval(interval);
            }, [startTime, endTime]);

            // Auto-scroll
            useEffect(() => {
                logsEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [logs]);

            // --- Actions ---
            const handleStartActivity = () => {
                if (!startTime) {
                const now = new Date();
                setStartTime(now);
                setEndTime(null);
                addLog('活動開始 / タイム計測スタート', 'milestone', now, 0);
                }
            };

            const handleEndActivity = () => {
                const now = new Date();
                setEndTime(now);
                addLog('活動終了 / タイム計測ストップ', 'milestone', now);
                setShowExport(true);
            };

            const handlePeriod = () => {
                const now = new Date();
                addLog(`--- 第 ${periodCount} ピリオド ---`, 'milestone', now);
                setPeriodCount(prev => prev + 1);
            };

            const handleResumeActivity = () => {
                const now = new Date();
                setEndTime(null);
                addLog('活動再開', 'milestone', now);
            };

            const handleResetClick = () => {
                setShowResetConfirm(true);
            };

            const executeReset = () => {
                setLogs([]);
                setStartTime(null);
                setEndTime(null);
                setElapsed(0);
                setInputText('');
                setIncidentNumber('');
                setPeriodCount(1);
                setShowExport(false);
                setShowResetConfirm(false);
            };

            const addLog = (content, type = 'note', customTime, customElapsed) => {
                const now = customTime || new Date();
                let currentElapsed = 0;
                
                if (startTime) {
                currentElapsed = Math.floor((now.getTime() - startTime.getTime()) / 1000);
                } else if (!startTime && !customTime) {
                    setStartTime(now);
                    currentElapsed = 0;
                } else if (customElapsed !== undefined) {
                    currentElapsed = customElapsed;
                }

                const newLog = {
                id: Math.random().toString(36).substr(2, 9),
                timestamp: now,
                elapsedSeconds: currentElapsed,
                content,
                type,
                };
                setLogs((prev) => [...prev, newLog]);
            };

            const handleManualSubmit = (e) => {
                e?.preventDefault();
                if (!inputText.trim()) return;
                addLog(inputText, 'note');
                setInputText('');
            };

            const copyToClipboard = () => {
                const header = incidentNumber ? `--- 事案番号: ${incidentNumber} ---\n` : '';
                const logText = logs.map(log => {
                const timeStr = formatTime(log.timestamp);
                const elapsedStr = formatElapsed(log.elapsedSeconds);
                return `[${timeStr}] (+${elapsedStr}) ${log.type === 'treatment' ? '【処置】' : ''} ${log.content}`;
                }).join('\n');
                const textToCopy = header + `\n--- 活動ログ (消防) ---\n` + logText;

                const fallbackCopy = (text) => {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed"; textArea.style.left = "-9999px"; textArea.style.top = "0";
                    document.body.appendChild(textArea); textArea.focus(); textArea.select();
                    try { document.execCommand('copy'); alert('クリップボードにコピーしました'); } 
                    catch (err) { alert('コピーに失敗しました'); }
                    document.body.removeChild(textArea);
                }

                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(textToCopy).then(() => alert('クリップボードにコピーしました')).catch(err => fallbackCopy(textToCopy));
                } else { fallbackCopy(textToCopy); }
            };

            const getLogColor = (type) => {
                switch (type) {
                case 'treatment': return 'bg-red-50 border-l-4 border-red-500 text-red-900';
                case 'milestone': return 'bg-blue-50 border-l-4 border-blue-500 text-blue-900 font-bold';
                case 'vitals': return 'bg-green-50 border-l-4 border-green-500 text-green-900';
                default: return 'bg-white border-l-4 border-gray-300 text-gray-800';
                }
            };

            // Main Render
            return (
                <>
                {showManual ? (
                    <Manual onClose={() => setShowManual(false)} />
                ) : (
                    <div className="no-print flex flex-col h-screen bg-gray-100 font-sans max-w-md mx-auto shadow-2xl overflow-hidden relative">
                    
                    {/* --- Header: Timer Area --- */}
                    <div className="bg-red-800 text-white p-4 shadow-md z-10">
                        <div className="flex justify-between items-center mb-2">
                            <div className="flex items-center gap-2">
                                <button onClick={() => setShowManual(true)} className="hover:text-yellow-400 transition-colors" title="マニュアル">
                                    <HelpCircle size={20} />
                                </button>
                                <div className="flex items-center gap-1">
                                    <Flame size={20} className="text-orange-400" />
                                    <h1 className="font-bold text-lg tracking-wider">FIRE MEMO</h1>
                                </div>
                            </div>
                            <div className="text-xs text-red-200">
                                {endTime ? `End: ${formatTime(endTime)}` : formatTime(new Date())}
                            </div>
                        </div>
                        
                        {/* --- Incident Number --- */}
                        <div className="flex items-center justify-between gap-3 mb-3">
                            <div className="flex items-center bg-red-900 rounded-lg p-2 flex-1 shadow-inner">
                                <Hash size={18} className="text-red-300 mr-2" />
                                <input type="text" placeholder="事案番号を入力" value={incidentNumber} onChange={(e) => setIncidentNumber(e.target.value)} className="flex-1 bg-transparent text-white placeholder-red-400 border-0 p-0 text-sm focus:ring-0 outline-none font-mono" />
                            </div>
                        </div>
                        
                        <div className="flex items-end justify-between gap-4">
                            <div>
                                <p className="text-xs text-red-300 uppercase mb-1">Elapsed Time</p>
                                <div className={`text-4xl font-mono font-bold tracking-tighter tabular-nums ${endTime ? 'text-yellow-400' : 'text-white'}`}>
                                {formatElapsed(elapsed)}
                                </div>
                            </div>
                            
                            <div className="flex flex-col gap-2 items-end flex-1">
                                {!startTime ? (
                                <button onClick={handleStartActivity} className="bg-green-600 hover:bg-green-500 text-white px-4 py-3 rounded shadow-lg font-bold text-sm flex items-center gap-2 transition-transform active:scale-95 border border-green-400">
                                    <Clock size={16} /> 計測開始
                                </button>
                                ) : !endTime ? (
                                <>
                                    <button onClick={handlePeriod} className="bg-green-600 hover:bg-green-500 text-white px-4 py-3 rounded shadow-lg font-bold text-sm flex items-center gap-2 transition-transform active:scale-95 w-full justify-center border border-green-400">
                                        <Flag size={16} /> ピリオド {periodCount}
                                    </button>
                                    <button onClick={handleEndActivity} className="bg-red-600 hover:bg-red-500 text-white px-4 py-3 rounded shadow-lg font-bold text-sm flex items-center gap-2 transition-transform active:scale-95 w-full justify-center border border-red-400">
                                        <StopCircle size={16} /> 活動終了
                                    </button>
                                </>
                                ) : (
                                <div className="flex flex-col gap-2 w-full min-w-[100px]">
                                    <button onClick={handleResetClick} className="bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-2 rounded text-xs flex items-center gap-1 justify-center w-full">
                                    <RotateCcw size={12} /> リセット
                                    </button>
                                    <button onClick={handleResumeActivity} className="bg-blue-900 hover:bg-blue-800 text-blue-200 px-3 py-2 rounded text-xs flex items-center gap-1 justify-center w-full">
                                    <Play size={10} /> 再開
                                    </button>
                                </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* --- Logs Area --- */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-100 pb-24">
                        {logs.length === 0 && (
                        <div className="text-center text-gray-400 mt-10 flex flex-col items-center">
                            <FileText size={48} className="mb-2 opacity-20" />
                            <p>消防活動ログがここに表示されます</p>
                            <p className="text-xs mt-2">下のボタンまたは入力で記録</p>
                        </div>
                        )}
                        {logs.map((log) => (
                        <div key={log.id} className={`p-3 rounded shadow-sm flex flex-col gap-1 ${getLogColor(log.type)}`}>
                            <div className="flex justify-between items-start">
                            <span className="text-sm font-medium">{log.content}</span>
                            <button onClick={() => setLogs(logs.filter(l => l.id !== log.id))} className="text-gray-400 hover:text-red-500 ml-2">
                                <Trash2 size={14} />
                            </button>
                            </div>
                            <div className="flex justify-between items-center mt-1 text-[10px] opacity-70 font-mono">
                                <span>Time: {formatTime(log.timestamp)}</span>
                                <span>+{formatElapsed(log.elapsedSeconds)}</span>
                            </div>
                        </div>
                        ))}
                        <div ref={logsEndRef} />
                    </div>

                    {/* --- Quick Actions Panel --- */}
                    <div className={`bg-white border-t border-gray-200 transition-all duration-300 ease-in-out ${quickActionsOpen ? 'h-auto' : 'h-10 overflow-hidden'}`}>
                        <div className="bg-gray-50 p-2 flex justify-center cursor-pointer hover:bg-gray-100" onClick={() => setQuickActionsOpen(!quickActionsOpen)}>
                            {quickActionsOpen ? <ChevronDown size={16} className="text-gray-500"/> : <ChevronUp size={16} className="text-gray-500"/>}
                        </div>
                        <div className="p-2 grid grid-cols-3 gap-2 overflow-y-auto max-h-60 bg-gray-50">
                            {QUICK_ACTIONS.map((action) => (
                            <button key={action.label} onClick={() => addLog(action.label, action.type)} disabled={!!endTime}
                                className={`py-2 px-1 rounded text-xs font-bold shadow-sm border transition-colors active:scale-95 ${action.type === 'treatment' ? 'bg-red-100 border-red-200 text-red-800 hover:bg-red-200' : action.type === 'milestone' ? 'bg-blue-100 border-blue-200 text-blue-800 hover:bg-blue-200' : 'bg-green-100 border-green-200 text-green-800 hover:bg-green-200'} ${!!endTime ? 'opacity-50' : ''}`}>
                                {action.label}
                            </button>
                            ))}
                        </div>
                    </div>

                    {/* --- Input Area --- */}
                    <div className="bg-white p-3 border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-20">
                        <form onSubmit={handleManualSubmit} className="flex items-center gap-2 mb-2">
                        <input type="text" value={inputText} onChange={(e) => setInputText(e.target.value)} placeholder={endTime ? "事後記録..." : "メモを入力..."} className="flex-1 bg-gray-100 border-0 rounded-full px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none" />
                        <button type="submit" disabled={!inputText.trim()} className="p-3 bg-blue-600 text-white rounded-full shadow-md disabled:bg-gray-300 disabled:cursor-not-allowed">
                            <Send size={20} />
                        </button>
                        </form>
                        <div className="flex justify-between items-center px-1">
                        <button type="button" onClick={() => setShowExport(true)} className="text-xs text-gray-500 flex items-center gap-1 hover:text-blue-600">
                            <FileText size={14} /> ログ書き出し
                        </button>
                        </div>
                    </div>

                    {/* --- Export Modal --- */}
                    {showExport && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-lg shadow-xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in duration-200">
                            <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                            <h2 className="font-bold text-gray-700 flex items-center gap-2"><Save size={18} /> 活動記録出力</h2>
                            <button onClick={() => setShowExport(false)} className="text-gray-400 hover:text-gray-600">✕</button>
                            </div>
                            <div className="p-4">
                            <textarea readOnly className="w-full h-48 bg-gray-50 border rounded p-2 text-xs font-mono leading-relaxed mb-4"
                                value={(incidentNumber ? `事案番号: ${incidentNumber}\n---\n` : '') + `\n--- 活動ログ (消防) ---\n` + logs.map(log => `[${formatTime(log.timestamp)}] (+${formatElapsed(log.elapsedSeconds)}) ${log.type === 'treatment' ? '【処置】' : ''} ${log.content}`).join('\n')} />
                            <div className="flex gap-2">
                                <button onClick={copyToClipboard} className="flex-1 bg-blue-600 text-white py-2 rounded flex justify-center items-center gap-2 hover:bg-blue-700"><Copy size={16} /> コピー</button>
                                <button onClick={() => setShowExport(false)} className="flex-1 bg-gray-200 text-gray-700 py-2 rounded hover:bg-gray-300">閉じる</button>
                            </div>
                            </div>
                        </div>
                        </div>
                    )}

                    {/* --- Reset Confirmation Modal --- */}
                    {showResetConfirm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-lg shadow-xl w-full max-w-xs overflow-hidden p-6 animate-in fade-in zoom-in duration-200">
                            <div className="flex items-center gap-3 mb-4 text-red-600"><AlertTriangle size={24} /> <h3 className="text-lg font-bold text-gray-900">新規活動の開始</h3></div>
                            <p className="text-sm text-gray-600 mb-6 leading-relaxed">現在の記録をすべて消去して、新しい活動を開始しますか？<br/><span className="text-red-500 text-xs font-bold block mt-2">※必要な場合は先に「ログ書き出し」を行ってください。</span></p>
                            <div className="flex gap-3">
                            <button onClick={executeReset} className="flex-1 bg-red-600 text-white py-2 rounded hover:bg-red-700 font-bold shadow-sm transition-colors">リセット</button>
                            <button onClick={() => setShowResetConfirm(false)} className="flex-1 bg-gray-100 text-gray-700 py-2 rounded hover:bg-gray-200 font-medium transition-colors">キャンセル</button>
                            </div>
                        </div>
                        </div>
                    )}
                    </div>
                )}
                </>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
