<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ドクターカー活動管理アプリ</title>
    
    <!-- Tailwind CSS (デザイン用) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel (ブラウザでReactを動かすためのライブラリ) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- アイコン等が正しく表示されるためのスタイル調整 -->
    <style>
        body { touch-action: manipulation; } /* ダブルタップ拡大防止 */
        input, textarea { font-size: 16px; } /* iOSでのズーム防止 */
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <!-- アプリケーションのコード -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        
        // Navigationアイコンを削除
        import { 
            Clock, Phone, MapPin, Ambulance, User, ArrowRight, Save, 
            History, RotateCcw, Copy, Siren, Trash2, 
            X, Check, ClipboardCheck 
        } from 'https://esm.sh/lucide-react@0.454.0?deps=react@18.2.0';

        // --- Components ---

        const StatusButton = ({ label, icon: Icon, onClick, active, colorClass }) => (
            <button
                onClick={onClick}
                className={`w-full flex items-center justify-between p-4 mb-3 rounded-xl shadow-lg transition-all transform active:scale-95 ${
                active 
                    ? 'bg-gray-700 text-gray-400 cursor-not-allowed' 
                    : `${colorClass} text-white font-bold text-lg`
                }`}
                disabled={active}
            >
                <div className="flex items-center gap-3">
                    <Icon size={24} />
                    <span>{label}</span>
                </div>
                <ArrowRight size={24} />
            </button>
        );

        const InputField = ({ label, name, value, onChange, placeholder, type = "text" }) => (
            <div className="mb-3">
                <label className="block text-gray-600 text-xs font-bold mb-1 ml-1">{label}</label>
                <input
                type={type}
                name={name}
                value={value}
                onChange={onChange}
                placeholder={placeholder}
                className="w-full bg-white border border-gray-300 text-gray-900 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none transition-colors"
                />
            </div>
        );

        // Generic Modal Component
        const Modal = ({ isOpen, onClose, title, children, colorClass = "bg-blue-900" }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 backdrop-blur-sm animate-in fade-in duration-200">
                <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col max-h-[90vh]">
                    <div className={`${colorClass} p-4 flex justify-between items-center shrink-0`}>
                        <h3 className="text-white font-bold text-lg">{title}</h3>
                        <button onClick={onClose} className="text-white/80 hover:text-white p-1 rounded-full hover:bg-white/10">
                        <X size={24} />
                        </button>
                    </div>
                    <div className="p-4 overflow-y-auto flex-grow">
                        {children}
                    </div>
                </div>
                </div>
            );
        };

        // --- Main App Component ---

        function App() {
            // View state: 'dashboard', 'active', 'history'
            const [view, setView] = useState('dashboard');
            
            // Modal state
            const [activeModal, setActiveModal] = useState(null); // null, 'clear', 'preview'
            const [previewText, setPreviewText] = useState('');
            const [copySuccess, setCopySuccess] = useState(false);

            // Current Mission Data
            const [missionId, setMissionId] = useState(null);
            const [status, setStatus] = useState('STANDBY'); 
            
            // Input Fields
            const [inputs, setInputs] = useState({
                callSource: '', 
                rendezvousUnit: '', 
                locationType: 'SCENE', 
                locationName: '', 
                siteCaller: '', 
                patientInfo: '',
                distBaseToScene: '', // 追加: 基地→現場距離
                distSceneToHospital: '', // 追加: 現場→病院距離
                notes: '' 
            });

            // Timestamps
            const [timestamps, setTimestamps] = useState({
                request: null,    
                dispatch: null,   
                arrival: null,    
                contact: null,    
                transport: null,  
                hospitalIn: null, 
                finished: null    
            });

            // History Data
            const [history, setHistory] = useState([]);

            // Current Clock
            const [currentTime, setCurrentTime] = useState(new Date());

            // --- Effects ---

            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                const savedHistory = localStorage.getItem('dc_mission_history');
                if (savedHistory) {
                setHistory(JSON.parse(savedHistory));
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('dc_mission_history', JSON.stringify(history));
            }, [history]);

            // --- Helper Functions ---

            const formatTime = (dateStr) => {
                if (!dateStr) return '--:--';
                const date = new Date(dateStr);
                return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            };

            const startMission = () => {
                const now = new Date();
                setMissionId(now.getTime()); 
                setInputs({
                callSource: '消防指令',
                rendezvousUnit: '',
                locationType: 'SCENE',
                locationName: '',
                siteCaller: '',
                patientInfo: '',
                distBaseToScene: '',
                distSceneToHospital: '',
                notes: ''
                });
                setTimestamps({
                request: now.toISOString(),
                dispatch: null,
                arrival: null,
                contact: null,
                transport: null,
                hospitalIn: null,
                finished: null
                });
                setStatus('DISPATCH');
                setView('active');
            };

            const updateStatus = (newStatus, timeKey) => {
                const now = new Date();
                setStatus(newStatus);
                if (timeKey && !timestamps[timeKey]) {
                setTimestamps(prev => ({ ...prev, [timeKey]: now.toISOString() }));
                }
            };

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setInputs(prev => ({ ...prev, [name]: value }));
            };

            const finishMission = () => {
                const now = new Date();
                const finalTimestamps = { ...timestamps, finished: now.toISOString() };
                setTimestamps(finalTimestamps);
                
                const missionRecord = {
                id: missionId,
                date: now.toLocaleDateString(),
                inputs,
                timestamps: finalTimestamps
                };

                setHistory(prev => [missionRecord, ...prev]);
                setStatus('STANDBY');
                setView('dashboard');
            };

            // --- History Management ---

            const initiateClearHistory = () => {
                setActiveModal('clear');
            };

            const confirmClearHistory = () => {
                setHistory([]);
                localStorage.removeItem('dc_mission_history');
                setActiveModal(null);
            };

            // --- Report Generation & Copy ---

            const generateReportText = (record) => {
                const t = record.timestamps;
                const i = record.inputs;

                // 距離情報の整形
                const distInfo = [];
                if (i.distBaseToScene) distInfo.push(`基地〜現場: ${i.distBaseToScene} km`);
                if (i.distSceneToHospital) distInfo.push(`現場〜病院: ${i.distSceneToHospital} km`);
                const distText = distInfo.length > 0 ? `\n[走行距離]\n${distInfo.join('\n')}` : '';

                return `
【ドクターカー活動記録】
日付: ${record.date}
------------------
[要請情報]
要請元: ${i.callSource}
通報者: ${i.siteCaller}
接触隊: ${i.rendezvousUnit}
場所: ${i.locationType === 'SCENE' ? '現場直行' : 'ドッキングP'} (${i.locationName})
------------------
[時系列]
要請覚知: ${formatTime(t.request)}
出動　　: ${formatTime(t.dispatch)}
現着　　: ${formatTime(t.arrival)}
接触　　: ${formatTime(t.contact)}
搬送開始: ${formatTime(t.transport)}
病院到着: ${formatTime(t.hospitalIn)}
完了　　: ${formatTime(t.finished)}${distText}
------------------
[メモ]
${i.notes}
                `.trim();
            };

            const openReportPreview = (record) => {
                const text = generateReportText(record);
                setPreviewText(text);
                setCopySuccess(false);
                setActiveModal('preview');
            };

            const executeCopy = () => {
                const textArea = document.createElement("textarea");
                textArea.value = previewText;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                textArea.style.top = "0";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        setCopySuccess(true);
                        setTimeout(() => setCopySuccess(false), 2000); 
                    } else {
                        alert('コピーに失敗しました');
                    }
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                    alert('コピーに失敗しました');
                }
                document.body.removeChild(textArea);
            };
            
            // openMap 関数を削除しました

            return (
                <div className="min-h-screen bg-gray-100 font-sans pb-10">
                
                {/* Header */}
                <header className="bg-blue-900 text-white p-4 shadow-md sticky top-0 z-40">
                    <div className="flex justify-between items-center">
                    <div className="flex items-center gap-2">
                        <Ambulance className="text-yellow-400" />
                        <h1 className="font-bold text-lg">Doctor Car Command</h1>
                    </div>
                    <div className="text-right">
                        <div className="text-2xl font-mono leading-none">{currentTime.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })}</div>
                        <div className="text-xs text-blue-200">{currentTime.toLocaleDateString()}</div>
                    </div>
                    </div>
                </header>

                {/* Dashboard View */}
                {view === 'dashboard' && (
                    <div className="p-4 max-w-md mx-auto">
                    <div className="bg-white rounded-2xl shadow-sm p-6 text-center mb-6">
                        <p className="text-gray-500 mb-2">現在のステータス</p>
                        <div className="text-4xl font-bold text-gray-800 mb-4">待機中</div>
                        <div className="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                        Ready for Mission
                        </div>
                    </div>

                    <button
                        onClick={startMission}
                        className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-6 px-4 rounded-2xl shadow-xl flex items-center justify-center gap-3 text-2xl animate-pulse"
                    >
                        <Phone size={32} />
                        要請受諾 (スタート)
                    </button>

                    <button
                        onClick={() => setView('history')}
                        className="w-full mt-6 bg-white border border-gray-300 text-gray-600 font-bold py-4 px-4 rounded-xl shadow-sm flex items-center justify-center gap-2"
                    >
                        <History size={20} />
                        過去の活動履歴
                    </button>
                    </div>
                )}

                {/* Active Mission View */}
                {view === 'active' && (
                    <div className="max-w-md mx-auto">
                    
                    {/* Status Control Panel */}
                    <div className="bg-blue-800 p-4 rounded-b-3xl shadow-lg mb-6 sticky top-[70px] z-30">
                        <div className="grid grid-cols-2 gap-2 text-white mb-3 text-sm">
                            <div className="bg-blue-700 p-2 rounded flex justify-between">
                                <span>覚知</span>
                                <span className="font-mono font-bold">{formatTime(timestamps.request)}</span>
                            </div>
                            <div className="bg-blue-700 p-2 rounded flex justify-between">
                                <span>出動</span>
                                <span className="font-mono font-bold">{formatTime(timestamps.dispatch)}</span>
                            </div>
                        </div>

                        {/* Dynamic Button based on current status */}
                        {status === 'DISPATCH' && (
                        <StatusButton 
                            label="出動開始 (Base Depart)" 
                            icon={Siren} 
                            onClick={() => updateStatus('ENROUTE', 'dispatch')} 
                            colorClass="bg-red-600 hover:bg-red-700" 
                        />
                        )}
                        {status === 'ENROUTE' && (
                        <StatusButton 
                            label="現着 (Arrived)" 
                            icon={MapPin} 
                            onClick={() => updateStatus('ARRIVED_SCENE', 'arrival')} 
                            colorClass="bg-orange-500 hover:bg-orange-600" 
                        />
                        )}
                        {status === 'ARRIVED_SCENE' && (
                        <StatusButton 
                            label="接触・合流 (Contact)" 
                            icon={User} 
                            onClick={() => updateStatus('CONTACT', 'contact')} 
                            colorClass="bg-green-600 hover:bg-green-700" 
                        />
                        )}
                        {status === 'CONTACT' && (
                        <StatusButton 
                            label="搬送開始 (Transport)" 
                            icon={Ambulance} 
                            onClick={() => updateStatus('TRANSPORT', 'transport')} 
                            colorClass="bg-purple-600 hover:bg-purple-700" 
                        />
                        )}
                        {status === 'TRANSPORT' && (
                        <StatusButton 
                            label="病院到着 (Hospital In)" 
                            icon={Save} 
                            onClick={() => updateStatus('HOSPITAL_ARR', 'hospitalIn')} 
                            colorClass="bg-blue-500 hover:bg-blue-600" 
                        />
                        )}
                        {status === 'HOSPITAL_ARR' && (
                        <button
                        onClick={finishMission}
                        className="w-full bg-gray-800 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-3"
                        >
                        <Save size={24} />
                        活動終了・記録保存
                        </button>
                        )}
                    </div>

                    {/* Input Forms */}
                    <div className="px-4 pb-20 space-y-4">
                        
                        {/* Critical Info Card */}
                        <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500">
                        <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <Phone size={18} className="text-red-500"/> 指令・ドッキング情報
                        </h3>
                        
                        <div className="mb-4">
                            <label className="block text-gray-600 text-xs font-bold mb-1">場所区分</label>
                            <div className="flex bg-gray-100 p-1 rounded-lg">
                            <button
                                onClick={() => setInputs(prev => ({...prev, locationType: 'SCENE'}))}
                                className={`flex-1 py-2 rounded-md text-sm font-bold transition-all ${inputs.locationType === 'SCENE' ? 'bg-red-500 text-white shadow' : 'text-gray-500'}`}
                            >
                                現場直行
                            </button>
                            <button
                                onClick={() => setInputs(prev => ({...prev, locationType: 'POINT'}))}
                                className={`flex-1 py-2 rounded-md text-sm font-bold transition-all ${inputs.locationType === 'POINT' ? 'bg-blue-500 text-white shadow' : 'text-gray-500'}`}
                            >
                                ドッキングP
                            </button>
                            </div>
                        </div>

                        <InputField 
                            label="ドッキング隊 (例: 北救急1)" 
                            name="rendezvousUnit" 
                            value={inputs.rendezvousUnit} 
                            onChange={handleInputChange} 
                            placeholder="接触する隊名..." 
                        />
                        
                        {/* 地図ボタンを削除し、住所入力のみシンプルに表示 */}
                        <InputField 
                            label="場所詳細・住所" 
                            name="locationName" 
                            value={inputs.locationName} 
                            onChange={handleInputChange}
                            placeholder="住所または目標物..." 
                        />

                        <InputField 
                            label="現場通報者 (誰からの電話?)" 
                            name="siteCaller" 
                            value={inputs.siteCaller} 
                            onChange={handleInputChange} 
                            placeholder="例: 指令課、救急隊長..." 
                        />
                        </div>

                        {/* Distance Info - NEW SECTION */}
                        <div className="bg-white p-4 rounded-xl shadow-sm">
                            <h3 className="font-bold text-gray-800 mb-3 text-sm flex items-center gap-2">
                                <Ambulance size={18} className="text-blue-500"/> 走行距離記録 (km)
                            </h3>
                            <div className="flex gap-3">
                                <div className="flex-1">
                                    <InputField 
                                        label="基地 ⇒ 現場" 
                                        name="distBaseToScene" 
                                        value={inputs.distBaseToScene} 
                                        onChange={handleInputChange} 
                                        placeholder="0.0" 
                                        type="number"
                                    />
                                </div>
                                <div className="flex-1">
                                    <InputField 
                                        label="現場 ⇒ 病院" 
                                        name="distSceneToHospital" 
                                        value={inputs.distSceneToHospital} 
                                        onChange={handleInputChange} 
                                        placeholder="0.0" 
                                        type="number"
                                    />
                                </div>
                            </div>
                        </div>

                        {/* Additional Info */}
                        <div className="bg-white p-4 rounded-xl shadow-sm">
                            <h3 className="font-bold text-gray-800 mb-3 text-sm">その他情報</h3>
                            <InputField 
                                label="患者情報・主訴" 
                                name="patientInfo" 
                                value={inputs.patientInfo} 
                                onChange={handleInputChange}
                                placeholder="70代男性 CPA..." 
                            />
                            <div className="mb-3">
                                <label className="block text-gray-600 text-xs font-bold mb-1 ml-1">活動メモ</label>
                                <textarea
                                    name="notes"
                                    value={inputs.notes}
                                    onChange={handleInputChange}
                                    className="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 h-24 focus:ring-2 focus:ring-blue-500 outline-none"
                                ></textarea>
                            </div>
                        </div>

                        {/* Time Log Preview */}
                        <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 text-sm">
                            <h4 className="font-bold text-gray-500 mb-2">時間記録プレビュー</h4>
                            <div className="grid grid-cols-2 gap-y-1">
                                <div className="text-gray-500">覚知</div><div className="font-mono">{formatTime(timestamps.request)}</div>
                                <div className="text-gray-500">出動</div><div className="font-mono">{formatTime(timestamps.dispatch)}</div>
                                <div className="text-gray-500">現着</div><div className="font-mono">{formatTime(timestamps.arrival)}</div>
                                <div className="text-gray-500">接触</div><div className="font-mono">{formatTime(timestamps.contact)}</div>
                                <div className="text-gray-500">搬送</div><div className="font-mono">{formatTime(timestamps.transport)}</div>
                                <div className="text-gray-500">病着</div><div className="font-mono">{formatTime(timestamps.hospitalIn)}</div>
                            </div>
                        </div>

                    </div>
                    </div>
                )}

                {/* History View */}
                {view === 'history' && (
                    <div className="max-w-md mx-auto p-4">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold text-gray-800">活動履歴</h2>
                        <div className="flex gap-2">
                            {history.length > 0 && (
                                <button 
                                    onClick={initiateClearHistory}
                                    className="bg-red-100 text-red-600 p-2 rounded-full hover:bg-red-200 mr-2"
                                    title="全履歴を消去"
                                >
                                    <Trash2 size={20} />
                                </button>
                            )}
                            <button 
                                onClick={() => setView('dashboard')}
                                className="bg-gray-200 p-2 rounded-full hover:bg-gray-300"
                            >
                                <RotateCcw size={20} />
                            </button>
                        </div>
                    </div>

                    {history.length === 0 ? (
                        <p className="text-center text-gray-400 mt-10">履歴はありません</p>
                    ) : (
                        <div className="space-y-4">
                        {history.map((record) => (
                            <div key={record.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <div className="flex justify-between items-start mb-2 border-b pb-2">
                                <div>
                                    <span className="text-xs font-bold text-blue-600 bg-blue-100 px-2 py-0.5 rounded mr-2">
                                        {record.inputs.locationType === 'SCENE' ? '現場直行' : 'ドッキング'}
                                    </span>
                                    <span className="font-bold text-gray-800">{formatTime(record.timestamps.request)} 受電</span>
                                </div>
                                <div className="text-xs text-gray-500">{record.date}</div>
                            </div>
                            
                            <div className="text-sm space-y-1 mb-3">
                                <div className="flex"><span className="w-20 text-gray-500">接触隊:</span> <span>{record.inputs.rendezvousUnit || '未入力'}</span></div>
                                <div className="flex"><span className="w-20 text-gray-500">場所:</span> <span className="truncate flex-1">{record.inputs.locationName || '未入力'}</span></div>
                                {/* 履歴表示にも距離を追加 */}
                                {record.inputs.distBaseToScene && (
                                    <div className="flex"><span className="w-20 text-gray-500">基地-現場:</span> <span>{record.inputs.distBaseToScene} km</span></div>
                                )}
                                {record.inputs.distSceneToHospital && (
                                    <div className="flex"><span className="w-20 text-gray-500">現場-病院:</span> <span>{record.inputs.distSceneToHospital} km</span></div>
                                )}
                            </div>

                            <div className="flex gap-2">
                                <button 
                                    onClick={() => openReportPreview(record)}
                                    className="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2"
                                >
                                    <Copy size={16} /> コピー (プレビュー)
                                </button>
                            </div>
                            </div>
                        ))}
                        </div>
                    )}
                    </div>
                )}

                {/* --- Modals --- */}
                
                {/* Clear Confirmation Modal */}
                <Modal 
                    isOpen={activeModal === 'clear'} 
                    onClose={() => setActiveModal(null)} 
                    title="履歴の消去"
                    colorClass="bg-red-600"
                >
                    <div className="text-center space-y-4 py-2">
                        <div className="bg-red-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto text-red-600">
                            <Trash2 size={32} />
                        </div>
                        <p className="text-gray-800 font-bold text-lg">本当に消去しますか？</p>
                        <p className="text-gray-500 text-sm">これまでの活動履歴がすべて削除されます。<br/>この操作は元に戻せません。</p>
                        
                        <div className="flex gap-3 pt-2">
                            <button 
                                onClick={() => setActiveModal(null)}
                                className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold"
                            >
                                キャンセル
                            </button>
                            <button 
                                onClick={confirmClearHistory}
                                className="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold shadow-lg"
                            >
                                全消去する
                            </button>
                        </div>
                    </div>
                </Modal>

                {/* Report Preview Modal */}
                <Modal 
                    isOpen={activeModal === 'preview'} 
                    onClose={() => setActiveModal(null)} 
                    title="活動記録プレビュー"
                    colorClass="bg-blue-900"
                >
                    <div className="space-y-4">
                        <div className="bg-gray-50 p-3 rounded-lg border border-gray-200 max-h-60 overflow-y-auto">
                            <pre className="whitespace-pre-wrap text-sm font-mono text-gray-800">{previewText}</pre>
                        </div>
                        <p className="text-xs text-gray-500 text-center">
                            内容を確認して、クリップボードにコピーしてください。
                        </p>
                        <button 
                            onClick={executeCopy}
                            className={`w-full py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 transition-all ${
                                copySuccess ? 'bg-green-500 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white'
                            }`}
                        >
                            {copySuccess ? (
                                <>
                                    <Check size={20} />
                                    コピー完了！
                                </>
                            ) : (
                                <>
                                    <ClipboardCheck size={20} />
                                    クリップボードにコピー
                                </>
                            )}
                        </button>
                    </div>
                </Modal>

                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
