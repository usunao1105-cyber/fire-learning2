<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>消防物品貸借管理</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs (v9 Compat or Modular via CDN is tricky in vanilla, using compat for ease in single file or module script) -->
    <!-- We will use ES modules with Babel for the cleanest modern React/Firebase integration in a single file -->
    <script type="importmap">
      {
        "imports": {
          "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
          "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
          "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
      }
    </script>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            updateDoc, 
            doc, 
            onSnapshot, 
            serverTimestamp, 
            query, 
            orderBy, 
            Timestamp 
        } from 'firebase/firestore';

        const React = window.React;
        const { useState, useEffect, useMemo } = React;

        // ==========================================
        //  設定エリア (ここを修正してください)
        // ==========================================
        const firebaseConfig = {
            // ここにFirebaseコンソールから取得した設定を貼り付けてください
            apiKey: "AIzaSyAv0PN4bWerICqnu2mAGX50EL8E4iSUvqQ",
            authDomain: "fire-lending-app.firebaseapp.com",
            projectId: "fire-lending-app",
            storageBucket: "fire-lending-app.firebasestorage.app",
            messagingSenderId: "879433305434",
            appId: "1:879433305434:web:f772d61dc8bdbeffce3763"
        };
        
        // アプリID（データベース内の保存場所を区別するためのID。自由に変更可）
        const appId = "firestation-lending-app"; 

        // ==========================================
        //  初期化処理
        // ==========================================
        let app, auth, db;
        try {
            if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                console.warn("Firebase設定がまだ行われていません。コード内のfirebaseConfigを修正してください。");
            } else {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            }
        } catch (e) {
            console.error("Firebase Initialization Error:", e);
        }

        // ==========================================
        //  アイコンコンポーネント (Lucide簡易版)
        // ==========================================
        const IconBase = ({ children, className }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width="24" height="24" 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {children}
            </svg>
        );

        const Truck = (props) => <IconBase {...props}><path d="M5 18H3c-.6 0-1-.4-1-1V7c0-.6.4-1 1-1h10c.6 0 1 .4 1 1v11"/><path d="M14 9h4l4 4v4c0 .6-.4 1-1 1h-2"/><circle cx="7" cy="18" r="2"/><circle cx="17" cy="18" r="2"/></IconBase>;
        const Building2 = (props) => <IconBase {...props}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></IconBase>;
        const Edit3 = (props) => <IconBase {...props}><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></IconBase>;
        const ArrowRightLeft = (props) => <IconBase {...props}><path d="m16 3 4 4-4 4"/><path d="M20 7H4"/><path d="m8 21-4-4 4-4"/><path d="M4 17h16"/></IconBase>;
        const CheckCircle2 = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></IconBase>;
        const AlertCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>;
        const CalendarIcon = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>;
        const ClipboardList = (props) => <IconBase {...props}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></IconBase>;
        const PlusCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></IconBase>;
        const CheckSquare = (props) => <IconBase {...props}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></IconBase>;
        const History = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></IconBase>;

        // ==========================================
        //  メインアプリ
        // ==========================================

        const formatDate = (timestamp) => {
            if (!timestamp || typeof timestamp.toDate !== 'function') return '---';
            try {
                const date = timestamp.toDate();
                return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
            } catch (e) {
                return '---';
            }
        };

        function App() {
            const [user, setUser] = useState(null);
            const [transactions, setTransactions] = useState([]);
            const [myUnit, setMyUnit] = useState(localStorage.getItem('fireStation_myUnit') || '');
            const [view, setView] = useState('dashboard');
            const [loading, setLoading] = useState(true);
            const [configError, setConfigError] = useState(false);

            useEffect(() => {
                if (!auth) {
                    setConfigError(true);
                    setLoading(false);
                    return;
                }

                // 匿名ログイン
                signInAnonymously(auth).catch((error) => {
                    console.error("Auth error:", error);
                });

                const unsubscribe = onAuthStateChanged(auth, (u) => setUser(u));
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !db) return;

                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'lending_transactions')
                );

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => {
                        const d = doc.data();
                        return {
                            id: doc.id,
                            ...d,
                            lender: typeof d.lender === 'string' ? d.lender : '不明',
                            borrower: typeof d.borrower === 'string' ? d.borrower : '不明',
                        };
                    });
                    data.sort((a, b) => {
                        const dateA = a.createdAt?.toMillis() || 0;
                        const dateB = b.createdAt?.toMillis() || 0;
                        return dateB - dateA;
                    });
                    setTransactions(data);
                    setLoading(false);
                }, (error) => {
                    console.error("Firestore error:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user]);

            const handleUnitChange = (e) => {
                const val = e.target.value;
                setMyUnit(val);
                localStorage.setItem('fireStation_myUnit', val);
            };

            const activeTransactions = transactions.filter(t => t.status === 'active');
            const lentByMe = myUnit ? activeTransactions.filter(t => t.lender === myUnit) : [];
            const borrowedByMe = myUnit ? activeTransactions.filter(t => t.borrower === myUnit) : [];

            const updateStatus = async (item, newStatus) => {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'lending_transactions', item.id), {
                        status: newStatus,
                        updatedAt: serverTimestamp()
                    });
                } catch (e) {
                    console.error(e);
                    alert("更新に失敗しました。権限を確認してください。");
                }
            };

            if (configError) {
                return (
                    <div className="p-10 text-center">
                        <h1 className="text-xl font-bold text-red-600 mb-4">設定が必要です</h1>
                        <p>HTMLファイル内の <code>firebaseConfig</code> を編集して、FirebaseのAPIキー等を設定してください。</p>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 font-sans pb-20">
                    {/* Header */}
                    <header className="bg-red-600 text-white shadow-lg sticky top-0 z-50">
                        <div className="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center space-x-2">
                                <Truck className="h-6 w-6" />
                                <h1 className="text-lg font-bold tracking-wide">消防物品貸借管理</h1>
                            </div>
                            <div className="text-xs bg-white/20 px-2 py-1 rounded">
                                {formatDate(Timestamp.now())}
                            </div>
                        </div>
                        
                        <div className="bg-red-800 px-4 py-3">
                            <div className="max-w-md mx-auto">
                                <div className="flex items-center space-x-2 text-sm text-white/90 mb-1">
                                    <Building2 className="w-4 h-4" />
                                    <label htmlFor="myUnitInput" className="font-bold">あなたの所属:</label>
                                </div>
                                <div className="relative">
                                    <input 
                                        id="myUnitInput"
                                        type="text"
                                        value={myUnit} 
                                        onChange={handleUnitChange}
                                        placeholder="所属名を入力 (例: 本署救助隊)"
                                        className="w-full bg-white text-slate-900 rounded px-3 py-2 text-base font-bold outline-none focus:ring-2 focus:ring-orange-400 shadow-inner"
                                    />
                                    <Edit3 className="absolute right-3 top-2.5 text-slate-400 w-4 h-4 pointer-events-none" />
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="max-w-md mx-auto px-4 py-6">
                        {loading ? (
                            <div className="flex justify-center py-10">
                                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-red-600"></div>
                            </div>
                        ) : (
                            <>
                                {view === 'dashboard' && (
                                    <Dashboard 
                                        lentByMe={lentByMe} 
                                        borrowedByMe={borrowedByMe} 
                                        myUnit={myUnit}
                                        onReturn={(item) => updateStatus(item, 'returned')}
                                    />
                                )}
                                {view === 'add' && (
                                    <AddTransactionForm 
                                        myUnit={myUnit} 
                                        onClose={() => setView('dashboard')}
                                    />
                                )}
                                {view === 'audit' && (
                                    <MonthlyAudit 
                                        myUnit={myUnit}
                                        transactions={activeTransactions}
                                    />
                                )}
                                {view === 'history' && (
                                    <HistoryView 
                                        transactions={transactions}
                                        myUnit={myUnit}
                                    />
                                )}
                            </>
                        )}
                    </main>

                    {/* Bottom Navigation */}
                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 shadow-lg z-40 pb-safe">
                        <div className="max-w-md mx-auto flex justify-around items-center h-16">
                            <NavItem icon={<ClipboardList />} label="一覧" active={view === 'dashboard'} onClick={() => setView('dashboard')} />
                            <NavItem icon={<PlusCircle className="text-red-600" />} label="貸出登録" active={view === 'add'} onClick={() => setView('add')} highlight />
                            <NavItem icon={<CheckSquare />} label="月末点検" active={view === 'audit'} onClick={() => setView('audit')} />
                            <NavItem icon={<History />} label="履歴" active={view === 'history'} onClick={() => setView('history')} />
                        </div>
                    </nav>
                </div>
            );
        }

        // --- Sub Components ---
        
        function Dashboard({ lentByMe, borrowedByMe, myUnit, onReturn }) {
            if (!myUnit) {
                return (
                    <div className="text-center py-12 px-4 bg-white rounded-xl shadow-md border-t-4 border-red-500">
                        <Building2 className="w-16 h-16 mx-auto text-slate-300 mb-4" />
                        <h2 className="text-xl font-bold text-slate-800 mb-2">所属を入力してください</h2>
                        <p className="text-slate-500 mb-4">画面上部の入力欄に、所属名を入力してください。</p>
                        <div className="text-sm text-red-500 font-bold bg-red-50 p-2 rounded">↑ 上の赤いエリアに入力</div>
                    </div>
                );
            }

            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-orange-500">
                            <p className="text-xs text-slate-500 font-bold mb-1">他部署へ貸出中</p>
                            <p className="text-2xl font-bold text-slate-800">{lentByMe.length}<span className="text-sm font-normal text-slate-400 ml-1">件</span></p>
                        </div>
                        <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
                            <p className="text-xs text-slate-500 font-bold mb-1">他部署から借用中</p>
                            <p className="text-2xl font-bold text-slate-800">{borrowedByMe.length}<span className="text-sm font-normal text-slate-400 ml-1">件</span></p>
                        </div>
                    </div>

                    <section>
                        <h2 className="text-sm font-bold text-slate-600 mb-3 flex items-center">
                            <ArrowRightLeft className="w-4 h-4 mr-1 text-blue-500" />
                            借りている物（要返却）
                        </h2>
                        {borrowedByMe.length === 0 ? (
                            <EmptyState message="現在借りているものはありません" />
                        ) : (
                            <div className="space-y-3">
                                {borrowedByMe.map(item => (
                                    <TransactionCard key={item.id} item={item} type="borrowed" onAction={() => onReturn(item)} />
                                ))}
                            </div>
                        )}
                    </section>

                    <section>
                        <h2 className="text-sm font-bold text-slate-600 mb-3 flex items-center">
                            <ArrowRightLeft className="w-4 h-4 mr-1 text-orange-500" />
                            貸している物
                        </h2>
                        {lentByMe.length === 0 ? (
                            <EmptyState message="現在貸しているものはありません" />
                        ) : (
                            <div className="space-y-3">
                                {lentByMe.map(item => (
                                    <TransactionCard key={item.id} item={item} type="lent" onAction={() => onReturn(item)} />
                                ))}
                            </div>
                        )}
                    </section>
                </div>
            );
        }

        function TransactionCard({ item, type, onAction }) {
            const isLent = type === 'lent';
            return (
                <div className="bg-white p-4 rounded-lg shadow-sm border border-slate-100 relative overflow-hidden group">
                    <div className={`absolute left-0 top-0 bottom-0 w-1 ${isLent ? 'bg-orange-400' : 'bg-blue-400'}`}></div>
                    <div className="pl-2">
                        <div className="flex justify-between items-start mb-2">
                            <h3 className="font-bold text-slate-800 text-lg">{item.itemName}</h3>
                            <span className="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded">
                                {formatDate(item.createdAt)}~
                            </span>
                        </div>
                        <div className="flex items-center text-sm text-slate-600 mb-2">
                            <span className="font-semibold mr-2 w-12 text-slate-400">{isLent ? '貸出先' : '借用元'}:</span>
                            <span className="font-bold bg-slate-100 px-2 py-0.5 rounded text-slate-800">{isLent ? item.borrower : item.lender}</span>
                        </div>
                         {item.returnDate && (
                            <div className="text-xs font-bold text-slate-600 mb-2 flex items-center bg-yellow-50 p-1.5 rounded w-fit">
                                <CalendarIcon className="w-3 h-3 mr-1 text-orange-500" />
                                返却予定: {item.returnDate}
                            </div>
                        )}
                        {item.notes && <p className="text-xs text-slate-500 mb-3 bg-slate-50 p-2 rounded">{item.notes}</p>}
                        
                        <div className="flex justify-between items-center mt-3 pt-3 border-t border-slate-100">
                             <div className="flex items-center">
                                {item.lastAuditedAt ? (
                                   <span className="text-xs flex items-center text-green-600">
                                     <CheckCircle2 className="w-3 h-3 mr-1" />
                                     {item.lastAuditedBy}確認済 ({formatDate(item.lastAuditedAt)})
                                   </span>
                                ) : (
                                  <span className="text-xs flex items-center text-red-500 font-bold">
                                    <AlertCircle className="w-3 h-3 mr-1" />
                                    未確認
                                  </span>
                                )}
                            </div>
                            <button onClick={onAction} className={`px-4 py-2 rounded-md text-sm font-bold transition-colors ${isLent ? 'bg-orange-50 text-orange-600 hover:bg-orange-100' : 'bg-blue-600 text-white hover:bg-blue-700 shadow-md shadow-blue-200'}`}>
                                {isLent ? '返却を確認' : '返却する'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function AddTransactionForm({ myUnit, onClose }) {
            const [itemName, setItemName] = useState('');
            const [targetUnit, setTargetUnit] = useState('');
            const [notes, setNotes] = useState('');
            const [returnDate, setReturnDate] = useState('');
            const [type, setType] = useState('lending'); 
            const [submitting, setSubmitting] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!myUnit.trim()) { alert("所属を入力してください"); return; }
                if (!itemName.trim()) { alert("物品名を入力してください"); return; }
                if (!targetUnit.trim()) { alert("相手の部署名を入力してください"); return; }
                setSubmitting(true);
                try {
                    const lender = type === 'lending' ? myUnit : targetUnit.trim();
                    const borrower = type === 'lending' ? targetUnit.trim() : myUnit;
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'lending_transactions'), {
                        itemName: itemName.trim(),
                        lender,
                        borrower,
                        notes: notes.trim(),
                        returnDate: returnDate || null,
                        status: 'active',
                        createdAt: serverTimestamp(),
                        lastAuditedAt: null,
                        updatedAt: serverTimestamp()
                    });
                    onClose();
                } catch (err) {
                    console.error(err);
                    alert("エラーが発生しました。");
                } finally {
                    setSubmitting(false);
                }
            };

            return (
                <div className="bg-white p-6 rounded-xl shadow-md animate-fade-in-up">
                    <h2 className="text-xl font-bold text-slate-800 mb-6 flex items-center">
                        <PlusCircle className="mr-2 text-red-600" />
                        新規登録
                    </h2>
                    <div className="flex mb-6 bg-slate-100 p-1 rounded-lg">
                        <button type="button" onClick={() => setType('lending')} className={`flex-1 py-2 text-sm font-bold rounded-md transition-all ${type === 'lending' ? 'bg-white text-orange-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>貸す</button>
                        <button type="button" onClick={() => setType('borrowing')} className={`flex-1 py-2 text-sm font-bold rounded-md transition-all ${type === 'borrowing' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>借りる</button>
                    </div>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-bold text-slate-700 mb-1">物品名</label>
                            <input type="text" value={itemName} onChange={(e) => setItemName(e.target.value)} className="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-red-500 outline-none" placeholder="例：40mmホース" required />
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-slate-700 mb-1">{type === 'lending' ? '貸出先（相手の部署名）' : '借用元（相手の部署名）'}</label>
                            <input type="text" value={targetUnit} onChange={(e) => setTargetUnit(e.target.value)} className="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-red-500 outline-none" placeholder="例：南出張所" required />
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-slate-700 mb-1">返却予定日（任意）</label>
                            <input type="date" value={returnDate} onChange={(e) => setReturnDate(e.target.value)} className="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-red-500 outline-none bg-white" />
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-slate-700 mb-1">備考</label>
                            <textarea value={notes} onChange={(e) => setNotes(e.target.value)} className="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-red-500 outline-none h-24" placeholder="備考" />
                        </div>
                        <div className="flex space-x-3 pt-4">
                            <button type="button" onClick={onClose} className="flex-1 py-3 text-slate-600 font-bold bg-slate-100 rounded-lg hover:bg-slate-200">キャンセル</button>
                            <button type="submit" disabled={submitting} className={`flex-1 py-3 text-white font-bold rounded-lg shadow-lg ${type === 'lending' ? 'bg-orange-500 hover:bg-orange-600' : 'bg-blue-500 hover:bg-blue-600'}`}>{submitting ? '登録中...' : '登録する'}</button>
                        </div>
                    </form>
                </div>
            );
        }

        function MonthlyAudit({ myUnit, transactions }) {
            if (!myUnit) return <div className="text-center py-10 text-slate-500">先に所属名を入力してください。</div>;
            const myAuditItems = transactions.filter(t => t.lender === myUnit || t.borrower === myUnit);
            
            const handleAudit = async (item) => {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'lending_transactions', item.id), {
                        lastAuditedAt: serverTimestamp(),
                        lastAuditedBy: myUnit
                    });
                } catch (e) {
                    console.error(e);
                }
            };

            const currentMonth = new Date().getMonth() + 1;
            const isAuditedThisMonth = (item) => {
                if (!item.lastAuditedAt) return false;
                const auditDate = item.lastAuditedAt.toDate();
                const now = new Date();
                return auditDate.getMonth() === now.getMonth() && auditDate.getFullYear() === now.getFullYear();
            };
            const pendingAudit = myAuditItems.filter(item => !isAuditedThisMonth(item));
            const completedAudit = myAuditItems.filter(item => isAuditedThisMonth(item));

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded-xl border-l-4 border-indigo-500 shadow-sm">
                        <h2 className="font-bold text-lg mb-1">{currentMonth}月の点検</h2>
                        <p className="text-sm text-slate-600">貸借物品の所在確認を行い、チェックしてください。</p>
                    </div>
                    <div className="space-y-2">
                        <h3 className="font-bold text-slate-700 flex items-center"><AlertCircle className="w-4 h-4 mr-1 text-red-500" />未確認リスト ({pendingAudit.length})</h3>
                        {pendingAudit.length === 0 ? <div className="p-4 bg-green-50 text-green-700 rounded-lg text-sm text-center">すべての確認が完了しています！</div> : pendingAudit.map(item => (
                            <div key={item.id} className="bg-white p-3 rounded-lg shadow-sm border border-slate-200 flex justify-between items-center">
                                <div>
                                    <div className="font-bold text-slate-800">{item.itemName}</div>
                                    <div className="text-xs text-slate-500 mt-1">{item.lender === myUnit ? <span className="text-orange-600 font-semibold">貸出中 ➔ {item.borrower}</span> : <span className="text-blue-600 font-semibold">借用中 ➔ {item.lender}</span>}</div>
                                </div>
                                <button onClick={() => handleAudit(item)} className="bg-indigo-50 text-indigo-600 px-3 py-2 rounded font-bold text-xs border border-indigo-200 hover:bg-indigo-100">確認完了</button>
                            </div>
                        ))}
                    </div>
                    {completedAudit.length > 0 && (
                        <div className="space-y-2 pt-4 border-t border-slate-200">
                            <h3 className="font-bold text-slate-400 text-sm flex items-center"><CheckCircle2 className="w-4 h-4 mr-1" />確認済み ({completedAudit.length})</h3>
                            {completedAudit.map(item => (
                                <div key={item.id} className="bg-slate-50 p-2 rounded border border-slate-100 flex justify-between items-center opacity-70">
                                    <span className="text-sm font-medium text-slate-600 line-through">{item.itemName}</span>
                                    <span className="text-xs text-green-600 font-bold">{formatDate(item.lastAuditedAt)} 済</span>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        function HistoryView({ transactions, myUnit }) {
            if (!myUnit) return <div className="text-center py-10 text-slate-500">先に所属名を入力してください。</div>;
            const history = transactions.filter(t => t.status === 'returned' && (t.lender === myUnit || t.borrower === myUnit));
            return (
                <div className="space-y-4">
                    <h2 className="font-bold text-lg text-slate-700">過去の履歴（返却済）</h2>
                    {history.length === 0 ? <EmptyState message="履歴はありません" /> : history.map(item => (
                        <div key={item.id} className="bg-white p-3 rounded-lg shadow-sm border border-slate-100">
                            <div className="flex justify-between"><span className="font-bold text-slate-700">{item.itemName}</span><span className="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded">返却済</span></div>
                            <div className="text-xs text-slate-500 mt-1 flex gap-2"><span>貸: {item.lender}</span><span>↔</span><span>借: {item.borrower}</span></div>
                            <div className="text-xs text-slate-400 mt-1 text-right">{formatDate(item.createdAt)} 〜 {formatDate(item.updatedAt)}</div>
                        </div>
                    ))}
                </div>
            );
        }

        function NavItem({ icon, label, active, onClick, highlight }) {
            return (
                <button onClick={onClick} className={`flex flex-col items-center justify-center w-full h-full transition-colors relative ${active ? 'text-red-600' : 'text-slate-400 hover:text-slate-600'}`}>
                    {highlight && <div className="absolute -top-5 bg-red-600 text-white rounded-full p-3 shadow-lg border-4 border-slate-50 transform hover:scale-110 transition-transform"><PlusCircle className="w-6 h-6 text-white" /></div>}
                    <div className={`${highlight ? 'opacity-0 h-6' : ''}`}>{React.isValidElement(icon) ? React.cloneElement(icon, { size: 24, strokeWidth: active ? 2.5 : 2 }) : null}</div>
                    <span className={`text-[10px] font-bold mt-1 ${highlight ? 'mt-7' : ''}`}>{label}</span>
                </button>
            );
        }

        function EmptyState({ message }) {
            return (
                <div className="text-center py-10 bg-slate-100 rounded-lg border-2 border-dashed border-slate-200">
                    <ClipboardList className="w-10 h-10 mx-auto text-slate-300 mb-2" />
                    <p className="text-sm text-slate-400 font-bold">{message}</p>
                </div>
            );
        }

        // ==========================================
        //  レンダリング
        // ==========================================
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
